# VPN 管理工具多環境支援重構計畫

## 1. 前言

本文件旨在規劃 `nlInc-vpnMgmtTools` 專案的重構方向，使其能夠支援 Staging 和 Production 兩個獨立的 VPN 環境。開發測試將在 Staging 環境進行，而實際營運操作則在 Production 環境執行。此重構計畫將著重於邏輯說明與方向，不包含具體程式碼實現。

## 2. 現狀分析 (假設)

目前專案中的腳本可能存在以下情況：

*   **環境配置耦合**：VPN 端點、憑證路徑、伺服器資訊等環境特定參數可能硬編碼在腳本中。
*   **缺乏環境切換機制**：沒有標準化或便捷的方式來切換操作目標環境。
*   **操作風險**：在單一配置下，容易誤操作到非預期環境，尤其是在 Staging 和 Production 之間。

## 3. 重構目標

*   **環境隔離**：確保 Staging 和 Production 環境的配置和操作完全分離，避免交叉影響。
*   **配置彈性**：能夠輕鬆管理和修改各環境的特定配置。
*   **操作明確**：使用者在執行任何操作前，都能清晰選擇或指定目標環境。
*   **維護簡便**：核心邏輯保持一致，僅環境配置不同，降低維護複雜度。

## 4. 重構方向與邏輯

### 4.1. 環境配置分離

核心思路是將所有環境特定的參數從腳本程式碼中抽離，改為由外部配置文件管理。

*   **建立環境配置文件**：
    *   為每個環境建立獨立的配置文件，例如：
        *   `config/staging.conf` (或 `.sh`，視乎載入方式)
        *   `config/production.conf`
    *   這些配置文件將包含：
        *   VPN 服務端點 URL 或 IP 地址
        *   API 金鑰或認證憑證路徑 (若適用)
        *   憑證相關路徑 (例如，EasyRSA 的 `vars` 文件路徑、憑證存儲路徑)
        *   特定於環境的預設參數 (例如，預設區域、實例類型等)
        *   日誌文件路徑或標識符
*   **主配置文件 (可選)**：
    *   可以有一個主配置文件 `config/main.conf`，用於存放通用配置或指向當前活動環境的配置。

### 4.2. 環境選擇機制

使用者需要一種明確的方式來指定當前操作的目標環境。

*   **啟動參數**：
    *   腳本執行時，透過命令列參數指定環境，例如：
      `./team_member_setup.sh --env staging`
      `./aws_vpn_admin.sh --env production`
*   **環境變數**：
    *   透過設定環境變數來指定，例如：
      `VPN_ENV=staging ./team_member_setup.sh`
*   **互動式選擇 (備選)**：
    *   若未透過參數或環境變數指定，腳本可以提示使用者選擇環境。但對於自動化腳本，參數化更佳。

### 4.3. 腳本模組化與配置載入

*   **核心庫 (`lib/`) 的調整**：
    *   `lib/core_functions.sh` 或類似的通用函數庫，應設計為接受環境配置作為參數，或從已載入的配置中讀取變數。
    *   避免在 `lib/` 中的腳本直接讀取特定環境的配置文件，應由主調用腳本負責載入和傳遞。
*   **主執行腳本的調整** (例如 `aws_vpn_admin.sh`, `team_member_setup.sh` 等)：
    1.  **解析環境參數**：腳本啟動時，首先解析 `--env` 參數或讀取 `VPN_ENV` 環境變數。
    2.  **載入對應配置**：根據獲取的環境標識 (staging/production)，載入相應的配置文件。例如，如果環境是 `staging`，則 `source config/staging.conf`。
    3.  **變數傳遞**：將從配置文件中讀取的變數用於後續操作，或傳遞給 `lib/` 中的函數。
    4.  **路徑處理**：所有與路徑相關的操作 (如憑證生成、日誌寫入) 都應基於當前載入的環境配置。

### 4.4. 功能影響範圍

*   **憑證管理 (`lib/cert_management.sh`)**：
    *   需要根據所選環境，使用不同的 EasyRSA 設定 ( `vars` 文件) 和憑證存儲目錄。
    *   確保 Staging 產生的憑證與 Production 的憑證分離存放和管理。
*   **AWS 設定與端點管理 (`lib/aws_setup.sh`, `lib/endpoint_creation.sh`, `lib/endpoint_management.sh`)**：
    *   API 呼叫、資源命名、標籤等都可能需要根據環境有所區別。
    *   例如，Staging 環境的 VPN 端點名稱可以包含 `staging` 字樣。
*   **使用者管理腳本** (例如 `team_member_setup.sh`, `revoke_member_access.sh`, `employee_offboarding.sh`)：
    *   這些腳本在執行時必須明確知道是在 Staging 還是 Production 環境操作使用者。

### 4.5. 安全性考量

*   **存取控制**：確保 Production 環境的配置文件和敏感資訊受到更嚴格的保護。
*   **操作確認**：對於 Production 環境的操作，可以考慮增加額外的確認步驟，防止誤操作。

## 5. 實施步驟建議

1.  **建立 `config` 目錄**：並在其中創建 `staging.conf` 和 `production.conf` 的初始版本。
2.  **定義配置參數**：梳理現有腳本，列出所有需要根據環境變化的參數，並將它們定義到新的配置文件中。
3.  **修改一個主腳本作為試點**：選擇一個相對簡單的腳本 (例如 `aws_vpn_admin.sh` 的某個查詢功能)，實現環境參數解析和配置載入邏輯。
4.  **逐步重構 `lib/` 中的核心函數**：使其能夠接受或讀取環境特定的配置。
5.  **推廣到所有腳本**：將成功的模式應用到專案中的其他腳本。
6.  **路徑調整**：確保所有涉及文件路徑的操作（如憑證、日誌）都使用來自環境配置的路徑。
7.  **全面測試**：
    *   獨立測試 Staging 環境的所有功能。
    *   獨立測試 Production 環境的所有功能。
    *   測試環境切換的正確性。
8.  **文件更新**：更新 `readme.md` 和 `vpn_connection_manual.md`，說明新的多環境操作方式。

## 6. 潛在風險與應對

*   **配置錯誤**：配置文件中的參數錯誤可能導致操作失敗或影響錯誤的環境。
    *   **應對**：仔細校對配置文件；增加配置檢查邏輯。
*   **腳本兼容性**：部分舊有邏輯可能難以直接適應新的配置方式。
    *   **應對**：投入足夠時間進行分析和重寫。
*   **使用者習慣改變**：團隊成員需要適應新的操作流程。
    *   **應對**：提供清晰的操作文檔和培訓。

## 7. 總結

透過上述重構，`nlInc-vpnMgmtTools` 專案將能更安全、更靈活地管理 Staging 和 Production 兩個 VPN 環境，降低操作風險，提高管理效率。
