#!/bin/bash

# CSR æ‰¹æ¬¡è™•ç†å·¥å…· - ç®¡ç†å“¡å°ˆç”¨
# ç”¨é€”ï¼šæ‰¹æ¬¡è™•ç†å¤šå€‹ CSR æ–‡ä»¶ï¼Œæ”¯æ´ S3 æ•´åˆ
# ç‰ˆæœ¬ï¼š1.0

# å…¨åŸŸè®Šæ•¸
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PARENT_DIR="$(dirname "$SCRIPT_DIR")"

# è¼‰å…¥ç’°å¢ƒç®¡ç†å™¨ (å¿…é ˆç¬¬ä¸€å€‹è¼‰å…¥)
source "$PARENT_DIR/lib/env_manager.sh"

# åˆå§‹åŒ–ç’°å¢ƒ
if ! env_init_for_script "process_csr_batch.sh"; then
    echo -e "${RED}éŒ¯èª¤: ç„¡æ³•åˆå§‹åŒ–ç’°å¢ƒç®¡ç†å™¨${NC}"
    exit 1
fi

# é©—è­‰ AWS Profile æ•´åˆ
echo -e "${BLUE}æ­£åœ¨é©—è­‰ AWS Profile è¨­å®š...${NC}"
if ! env_validate_profile_integration "$CURRENT_ENVIRONMENT" "true"; then
    echo -e "${YELLOW}è­¦å‘Š: AWS Profile è¨­å®šå¯èƒ½æœ‰å•é¡Œï¼Œä½†ç¹¼çºŒåŸ·è¡Œæ‰¹æ¬¡è™•ç†å·¥å…·${NC}"
fi

# è¨­å®šç’°å¢ƒç‰¹å®šè·¯å¾‘
env_setup_paths

# è¼‰å…¥æ ¸å¿ƒå‡½å¼åº«
source "$PARENT_DIR/lib/core_functions.sh"

# åŸ·è¡Œå…¼å®¹æ€§æª¢æŸ¥
check_macos_compatibility

# é¡è‰²å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# é è¨­é…ç½® (ç’°å¢ƒæ„ŸçŸ¥)
get_default_bucket_name() {
    case "$CURRENT_ENVIRONMENT" in
        staging)
            echo "staging-vpn-csr-exchange"
            ;;
        production)
            echo "production-vpn-csr-exchange"
            ;;
        *)
            echo "vpn-csr-exchange"
            ;;
    esac
}

DEFAULT_BUCKET_NAME="$(get_default_bucket_name)"
DEFAULT_DAYS_VALID=365

# ä½¿ç”¨èªªæ˜
show_usage() {
    echo "ç”¨æ³•: $0 [é¸é …] [æ“ä½œ]"
    echo ""
    echo "æ“ä½œ:"
    echo "  download        å¾ S3 ä¸‹è¼‰å¾…è™•ç†çš„ CSR"
    echo "  process         æ‰¹æ¬¡ç°½ç½²æœ¬åœ° CSR æ–‡ä»¶"
    echo "  upload          ä¸Šå‚³ç°½ç½²çš„è­‰æ›¸åˆ° S3"
    echo "  monitor         ç›£æ§ S3 ä¸­çš„æ–° CSR ä¸¦è‡ªå‹•è™•ç†"
    echo "  status          é¡¯ç¤ºè™•ç†ç‹€æ…‹"
    echo ""
    echo "é¸é …:"
    echo "  -b, --bucket-name NAME     S3 å­˜å„²æ¡¶åç¨± (é è¨­: $DEFAULT_BUCKET_NAME)"
    echo "  -e, --environment ENV      ç›®æ¨™ç’°å¢ƒ (staging/production)"
    echo "  -d, --days DAYS           è­‰æ›¸æœ‰æ•ˆå¤©æ•¸ (é è¨­: $DEFAULT_DAYS_VALID)"
    echo "  -i, --input-dir DIR       CSR è¼¸å…¥ç›®éŒ„ (é è¨­: ./csr-inbox)"
    echo "  -o, --output-dir DIR      è­‰æ›¸è¼¸å‡ºç›®éŒ„ (é è¨­: ./cert-outbox)"
    echo "  -p, --profile PROFILE     AWS CLI profile"
    echo "  --auto-upload             è‡ªå‹•ä¸Šå‚³ç°½ç½²çš„è­‰æ›¸åˆ° S3"
    echo "  --notify                  è™•ç†å®Œæˆå¾Œç™¼é€é€šçŸ¥"
    echo "  -v, --verbose             é¡¯ç¤ºè©³ç´°è¼¸å‡º"
    echo "  -h, --help               é¡¯ç¤ºæ­¤å¹«åŠ©è¨Šæ¯"
    echo ""
    echo "ç¯„ä¾‹:"
    echo "  $0 download                           # ä¸‹è¼‰å¾…è™•ç† CSR"
    echo "  $0 process -e production              # æ‰¹æ¬¡è™•ç† production CSR"
    echo "  $0 upload --auto-upload               # ä¸Šå‚³ä¸¦è‡ªå‹•é€šçŸ¥"
    echo "  $0 monitor -e staging                 # ç›£æ§ staging ç’°å¢ƒ"
    echo ""
    echo "å·¥ä½œæµç¨‹:"
    echo "  1. download: å¾ S3 ä¸‹è¼‰æ–°çš„ CSR åˆ°æœ¬åœ°"
    echo "  2. process:  æ‰¹æ¬¡ç°½ç½²æ‰€æœ‰ CSR"
    echo "  3. upload:   ä¸Šå‚³ç°½ç½²çš„è­‰æ›¸å› S3"
    echo "  4. notify:   é€šçŸ¥ç”¨æˆ¶è­‰æ›¸å·²æº–å‚™"
}

# è¨˜éŒ„å‡½æ•¸
log_message() {
    local message="$1"
    echo "$(date '+%Y-%m-%d %H:%M:%S'): $message" >> "$LOG_FILE"
    if [ "$VERBOSE" = true ]; then
        echo -e "${BLUE}[LOG]${NC} $message"
    fi
}

# æª¢æŸ¥ä¾è³´å·¥å…·
check_dependencies() {
    local missing_tools=()
    
    # æª¢æŸ¥å¿…éœ€å·¥å…·
    for tool in aws openssl jq; do
        if ! command -v "$tool" &> /dev/null; then
            missing_tools+=("$tool")
        fi
    done
    
    if [ ${#missing_tools[@]} -gt 0 ]; then
        echo -e "${RED}ç¼ºå°‘å¿…éœ€å·¥å…·: ${missing_tools[*]}${NC}"
        return 1
    fi
    
    # æª¢æŸ¥ sign_csr.sh
    if [ ! -x "$SCRIPT_DIR/sign_csr.sh" ]; then
        echo -e "${RED}æ‰¾ä¸åˆ° sign_csr.sh æˆ–ç„¡åŸ·è¡Œæ¬Šé™${NC}"
        return 1
    fi
    
    echo -e "${GREEN}âœ“ æ‰€æœ‰ä¾è³´å·¥å…·å·²å°±ç·’${NC}"
    return 0
}

# è¨­ç½®å·¥ä½œç›®éŒ„
setup_directories() {
    echo -e "${BLUE}è¨­ç½®å·¥ä½œç›®éŒ„...${NC}"
    
    mkdir -p "$INPUT_DIR" "$OUTPUT_DIR" "$WORK_DIR"
    
    # å‰µå»ºè™•ç†è¨˜éŒ„ç›®éŒ„
    mkdir -p "$WORK_DIR/processed" "$WORK_DIR/failed" "$WORK_DIR/logs"
    
    echo -e "${GREEN}âœ“ å·¥ä½œç›®éŒ„å·²æº–å‚™${NC}"
    echo -e "  ğŸ“¥ CSR è¼¸å…¥: $INPUT_DIR"
    echo -e "  ğŸ“¤ è­‰æ›¸è¼¸å‡º: $OUTPUT_DIR"
    echo -e "  ğŸ› ï¸  å·¥ä½œç›®éŒ„: $WORK_DIR"
    
    return 0
}

# å¾ S3 ä¸‹è¼‰ CSR
download_csrs_from_s3() {
    echo -e "${BLUE}å¾ S3 ä¸‹è¼‰ CSR æ–‡ä»¶...${NC}"
    
    # æª¢æŸ¥ S3 é€£æ¥
    if ! aws s3 ls "s3://$BUCKET_NAME/csr/" --profile "$AWS_PROFILE" &>/dev/null; then
        echo -e "${RED}ç„¡æ³•è¨ªå• S3 å­˜å„²æ¡¶: $BUCKET_NAME${NC}"
        return 1
    fi
    
    # åˆ—å‡ºå¾…è™•ç†çš„ CSR
    local csr_files
    csr_files=$(aws s3 ls "s3://$BUCKET_NAME/csr/" --profile "$AWS_PROFILE" | awk '{print $4}' | grep '\.csr$')
    
    if [ -z "$csr_files" ]; then
        echo -e "${YELLOW}æ²’æœ‰å¾…è™•ç†çš„ CSR æ–‡ä»¶${NC}"
        return 0
    fi
    
    local download_count=0
    echo -e "${CYAN}ç™¼ç¾ CSR æ–‡ä»¶ï¼š${NC}"
    
    while IFS= read -r csr_file; do
        if [ -n "$csr_file" ]; then
            echo -e "  ğŸ“„ $csr_file"
            
            # ä¸‹è¼‰ CSR
            if aws s3 cp "s3://$BUCKET_NAME/csr/$csr_file" "$INPUT_DIR/$csr_file" --profile "$AWS_PROFILE"; then
                log_message "ä¸‹è¼‰ CSR: $csr_file"
                ((download_count++))
            else
                echo -e "${RED}ä¸‹è¼‰å¤±æ•—: $csr_file${NC}"
            fi
        fi
    done <<< "$csr_files"
    
    echo -e "${GREEN}âœ“ å·²ä¸‹è¼‰ $download_count å€‹ CSR æ–‡ä»¶${NC}"
    return 0
}

# æ‰¹æ¬¡è™•ç† CSR
process_csrs() {
    echo -e "${BLUE}æ‰¹æ¬¡è™•ç† CSR æ–‡ä»¶...${NC}"
    
    # æŸ¥æ‰¾æ‰€æœ‰ CSR æ–‡ä»¶
    local csr_files
    csr_files=$(find "$INPUT_DIR" -name "*.csr" -type f)
    
    if [ -z "$csr_files" ]; then
        echo -e "${YELLOW}æ²’æœ‰æ‰¾åˆ° CSR æ–‡ä»¶${NC}"
        return 0
    fi
    
    local processed_count=0
    local failed_count=0
    
    echo -e "${CYAN}é–‹å§‹è™•ç† CSR æ–‡ä»¶ï¼š${NC}"
    
    while IFS= read -r csr_file; do
        if [ -n "$csr_file" ]; then
            local basename
            basename=$(basename "$csr_file")
            local username="${basename%.csr}"
            
            echo -e "${BLUE}è™•ç†: $basename${NC}"
            
            # æª¢æŸ¥æ˜¯å¦å·²è™•ç†é
            if [ -f "$WORK_DIR/processed/$basename" ]; then
                echo -e "${YELLOW}  â­ï¸  å·²è™•ç†ï¼Œè·³é${NC}"
                continue
            fi
            
            # èª¿ç”¨ sign_csr.sh
            if "$SCRIPT_DIR/sign_csr.sh" \
                -e "$ENVIRONMENT" \
                "$csr_file" \
                "$DAYS_VALID" \
                "$OUTPUT_DIR"; then
                
                echo -e "${GREEN}  âœ“ ç°½ç½²æˆåŠŸ${NC}"
                
                # è¨˜éŒ„è™•ç†æˆåŠŸ
                echo "$(date '+%Y-%m-%d %H:%M:%S'): $basename" >> "$WORK_DIR/processed/$basename"
                log_message "ç°½ç½²æˆåŠŸ: $basename"
                ((processed_count++))
                
                # ç§»å‹•å·²è™•ç†çš„ CSR
                mv "$csr_file" "$WORK_DIR/processed/"
                
            else
                echo -e "${RED}  âœ— ç°½ç½²å¤±æ•—${NC}"
                
                # è¨˜éŒ„è™•ç†å¤±æ•—
                echo "$(date '+%Y-%m-%d %H:%M:%S'): $basename - ç°½ç½²å¤±æ•—" >> "$WORK_DIR/failed/$basename.log"
                log_message "ç°½ç½²å¤±æ•—: $basename"
                ((failed_count++))
                
                # ç§»å‹•å¤±æ•—çš„ CSR
                mv "$csr_file" "$WORK_DIR/failed/"
            fi
        fi
    done <<< "$csr_files"
    
    echo -e "${GREEN}âœ“ è™•ç†å®Œæˆ - æˆåŠŸ: $processed_count, å¤±æ•—: $failed_count${NC}"
    
    # ç”Ÿæˆè™•ç†å ±å‘Š
    generate_processing_report "$processed_count" "$failed_count"
    
    return 0
}

# ä¸Šå‚³è­‰æ›¸åˆ° S3
upload_certificates_to_s3() {
    echo -e "${BLUE}ä¸Šå‚³è­‰æ›¸åˆ° S3...${NC}"
    
    # æŸ¥æ‰¾æ‰€æœ‰è­‰æ›¸æ–‡ä»¶
    local cert_files
    cert_files=$(find "$OUTPUT_DIR" -name "*.crt" -type f)
    
    if [ -z "$cert_files" ]; then
        echo -e "${YELLOW}æ²’æœ‰æ‰¾åˆ°è­‰æ›¸æ–‡ä»¶${NC}"
        return 0
    fi
    
    local upload_count=0
    
    echo -e "${CYAN}ä¸Šå‚³è­‰æ›¸æ–‡ä»¶ï¼š${NC}"
    
    while IFS= read -r cert_file; do
        if [ -n "$cert_file" ]; then
            local basename
            basename=$(basename "$cert_file")
            
            echo -e "  ğŸ“¤ $basename"
            
            # ä¸Šå‚³è­‰æ›¸
            if aws s3 cp "$cert_file" "s3://$BUCKET_NAME/cert/$basename" --profile "$AWS_PROFILE"; then
                log_message "ä¸Šå‚³è­‰æ›¸: $basename"
                ((upload_count++))
                
                # ç§»å‹•å·²ä¸Šå‚³çš„è­‰æ›¸
                mkdir -p "$WORK_DIR/uploaded"
                mv "$cert_file" "$WORK_DIR/uploaded/"
            else
                echo -e "${RED}ä¸Šå‚³å¤±æ•—: $basename${NC}"
            fi
        fi
    done <<< "$cert_files"
    
    echo -e "${GREEN}âœ“ å·²ä¸Šå‚³ $upload_count å€‹è­‰æ›¸æ–‡ä»¶${NC}"
    return 0
}

# ç›£æ§æ¨¡å¼
monitor_mode() {
    echo -e "${BLUE}å•Ÿå‹•ç›£æ§æ¨¡å¼...${NC}"
    echo -e "${YELLOW}ç›£æ§ S3 å­˜å„²æ¡¶: $BUCKET_NAME${NC}"
    echo -e "${YELLOW}æª¢æŸ¥é–“éš”: 30 ç§’${NC}"
    echo -e "${YELLOW}æŒ‰ Ctrl+C åœæ­¢ç›£æ§${NC}"
    echo -e ""
    
    while true; do
        echo -e "${CYAN}[$(date '+%H:%M:%S')] æª¢æŸ¥æ–°çš„ CSR...${NC}"
        
        # ä¸‹è¼‰æ–° CSR
        download_csrs_from_s3
        
        # è™•ç† CSR
        process_csrs
        
        # è‡ªå‹•ä¸Šå‚³ï¼ˆå¦‚æœå•Ÿç”¨ï¼‰
        if [ "$AUTO_UPLOAD" = true ]; then
            upload_certificates_to_s3
        fi
        
        echo -e "${BLUE}ç­‰å¾… 30 ç§’...${NC}"
        sleep 30
    done
}

# é¡¯ç¤ºè™•ç†ç‹€æ…‹
show_status() {
    echo -e "${CYAN}========================================${NC}"
    echo -e "${CYAN}CSR æ‰¹æ¬¡è™•ç†ç‹€æ…‹${NC}"
    echo -e "${CYAN}========================================${NC}"
    echo -e ""
    
    # çµ±è¨ˆæœ¬åœ°æ–‡ä»¶
    local pending_csrs
    pending_csrs=$(find "$INPUT_DIR" -name "*.csr" -type f | wc -l)
    
    local ready_certs
    ready_certs=$(find "$OUTPUT_DIR" -name "*.crt" -type f | wc -l)
    
    local processed_csrs
    processed_csrs=$(find "$WORK_DIR/processed" -name "*.csr" -type f 2>/dev/null | wc -l)
    
    local failed_csrs
    failed_csrs=$(find "$WORK_DIR/failed" -name "*.csr" -type f 2>/dev/null | wc -l)
    
    echo -e "${BLUE}æœ¬åœ°ç‹€æ…‹ï¼š${NC}"
    echo -e "  ğŸ“¥ å¾…è™•ç† CSR: $pending_csrs"
    echo -e "  ğŸ“¤ å¾…ä¸Šå‚³è­‰æ›¸: $ready_certs"
    echo -e "  âœ… å·²è™•ç† CSR: $processed_csrs"
    echo -e "  âŒ è™•ç†å¤±æ•—: $failed_csrs"
    echo -e ""
    
    # æª¢æŸ¥ S3 ç‹€æ…‹
    if aws s3 ls "s3://$BUCKET_NAME/csr/" --profile "$AWS_PROFILE" &>/dev/null; then
        local s3_csrs
        s3_csrs=$(aws s3 ls "s3://$BUCKET_NAME/csr/" --profile "$AWS_PROFILE" | grep -c '\.csr$' || echo "0")
        
        local s3_certs
        s3_certs=$(aws s3 ls "s3://$BUCKET_NAME/cert/" --profile "$AWS_PROFILE" | grep -c '\.crt$' || echo "0")
        
        echo -e "${BLUE}S3 ç‹€æ…‹ï¼š${NC}"
        echo -e "  ğŸ“„ S3 ä¸­çš„ CSR: $s3_csrs"
        echo -e "  ğŸ“„ S3 ä¸­çš„è­‰æ›¸: $s3_certs"
    else
        echo -e "${YELLOW}ç„¡æ³•è¨ªå• S3 å­˜å„²æ¡¶${NC}"
    fi
    
    echo -e ""
    
    # é¡¯ç¤ºæœ€è¿‘çš„è™•ç†æ—¥èªŒ
    if [ -f "$LOG_FILE" ]; then
        echo -e "${BLUE}æœ€è¿‘çš„è™•ç†è¨˜éŒ„ï¼š${NC}"
        tail -5 "$LOG_FILE" | while IFS= read -r line; do
            echo -e "  $line"
        done
    fi
}

# ç”Ÿæˆè™•ç†å ±å‘Š
generate_processing_report() {
    local processed_count="$1"
    local failed_count="$2"
    local report_file="$WORK_DIR/logs/report-$(date +%Y%m%d-%H%M%S).txt"
    
    cat > "$report_file" << EOF
CSR æ‰¹æ¬¡è™•ç†å ±å‘Š
================
è™•ç†æ™‚é–“: $(date)
ç’°å¢ƒ: $ENVIRONMENT
å­˜å„²æ¡¶: $BUCKET_NAME

è™•ç†çµ±è¨ˆ:
- æˆåŠŸè™•ç†: $processed_count
- è™•ç†å¤±æ•—: $failed_count
- ç¸½è¨ˆ: $((processed_count + failed_count))

æˆåŠŸè™•ç†çš„æ–‡ä»¶:
EOF
    
    # æ·»åŠ æˆåŠŸè™•ç†çš„æ–‡ä»¶åˆ—è¡¨
    if [ -d "$WORK_DIR/processed" ]; then
        find "$WORK_DIR/processed" -name "*.csr" -type f -printf "- %f\n" >> "$report_file"
    fi
    
    echo -e "\nå¤±æ•—è™•ç†çš„æ–‡ä»¶:" >> "$report_file"
    if [ -d "$WORK_DIR/failed" ]; then
        find "$WORK_DIR/failed" -name "*.csr" -type f -printf "- %f\n" >> "$report_file"
    fi
    
    echo -e "${GREEN}âœ“ è™•ç†å ±å‘Šå·²ç”Ÿæˆ: $report_file${NC}"
}

# æ¸…ç†å‡½æ•¸
cleanup() {
    echo -e "${BLUE}æ­£åœ¨æ¸…ç†...${NC}"
    # å¯ä»¥æ·»åŠ æ¸…ç†é‚è¼¯
    exit 0
}

# ä¸»å‡½æ•¸
main() {
    # é è¨­å€¼
    BUCKET_NAME="$DEFAULT_BUCKET_NAME"
    ENVIRONMENT=""
    DAYS_VALID="$DEFAULT_DAYS_VALID"
    INPUT_DIR="./csr-inbox"
    OUTPUT_DIR="./cert-outbox"
    WORK_DIR="./csr-work"
    # Get AWS profile from environment manager
    AWS_PROFILE="$(env_get_profile "$CURRENT_ENVIRONMENT" 2>/dev/null || echo default)"
    AUTO_UPLOAD=false
    NOTIFY=false
    VERBOSE=false
    OPERATION=""
    
    # è§£æå‘½ä»¤è¡Œåƒæ•¸
    while [[ $# -gt 0 ]]; do
        case $1 in
            -b|--bucket-name)
                BUCKET_NAME="$2"
                shift 2
                ;;
            -e|--environment)
                ENVIRONMENT="$2"
                shift 2
                ;;
            -d|--days)
                DAYS_VALID="$2"
                shift 2
                ;;
            -i|--input-dir)
                INPUT_DIR="$2"
                shift 2
                ;;
            -o|--output-dir)
                OUTPUT_DIR="$2"
                shift 2
                ;;
            -p|--profile)
                AWS_PROFILE="$2"
                shift 2
                ;;
            --auto-upload)
                AUTO_UPLOAD=true
                shift
                ;;
            --notify)
                NOTIFY=true
                shift
                ;;
            -v|--verbose)
                VERBOSE=true
                shift
                ;;
            -h|--help)
                show_usage
                exit 0
                ;;
            download|process|upload|monitor|status)
                OPERATION="$1"
                shift
                ;;
            *)
                echo -e "${RED}æœªçŸ¥åƒæ•¸: $1${NC}"
                show_usage
                exit 1
                ;;
        esac
    done
    
    # æª¢æŸ¥å¿…éœ€åƒæ•¸
    if [ -z "$OPERATION" ]; then
        echo -e "${RED}éŒ¯èª¤: å¿…é ˆæŒ‡å®šæ“ä½œ${NC}"
        show_usage
        exit 1
    fi
    
    if [ -z "$ENVIRONMENT" ] && [[ "$OPERATION" != "status" ]]; then
        echo -e "${RED}éŒ¯èª¤: å¿…é ˆæŒ‡å®šç’°å¢ƒ (-e staging/production)${NC}"
        exit 1
    fi
    
    # è¨­ç½®æ—¥èªŒæ–‡ä»¶
    LOG_FILE="$PARENT_DIR/logs/${ENVIRONMENT:-common}/csr_batch.log"
    mkdir -p "$(dirname "$LOG_FILE")"
    
    # è¨­ç½®ä¿¡è™Ÿè™•ç†
    trap cleanup INT TERM
    
    echo -e "${CYAN}========================================${NC}"
    echo -e "${CYAN}CSR æ‰¹æ¬¡è™•ç†å·¥å…·${NC}"
    echo -e "${CYAN}========================================${NC}"
    echo -e "${BLUE}æ“ä½œ: $OPERATION${NC}"
    echo -e "${BLUE}ç’°å¢ƒ: ${ENVIRONMENT:-N/A}${NC}"
    echo -e "${BLUE}å­˜å„²æ¡¶: $BUCKET_NAME${NC}"
    echo -e ""
    
    # æª¢æŸ¥ä¾è³´
    if ! check_dependencies; then
        exit 1
    fi
    
    # è¨­ç½®å·¥ä½œç›®éŒ„
    if ! setup_directories; then
        exit 1
    fi
    
    # åŸ·è¡ŒæŒ‡å®šæ“ä½œ
    case "$OPERATION" in
        download)
            download_csrs_from_s3
            ;;
        process)
            process_csrs
            ;;
        upload)
            upload_certificates_to_s3
            ;;
        monitor)
            monitor_mode
            ;;
        status)
            show_status
            ;;
        *)
            echo -e "${RED}æœªçŸ¥æ“ä½œ: $OPERATION${NC}"
            exit 1
            ;;
    esac
    
    log_message "æ‰¹æ¬¡è™•ç†æ“ä½œå®Œæˆ: $OPERATION"
}

# åªæœ‰åœ¨è…³æœ¬ç›´æ¥åŸ·è¡Œæ™‚æ‰åŸ·è¡Œä¸»ç¨‹åº
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi