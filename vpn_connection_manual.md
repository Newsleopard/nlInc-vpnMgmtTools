<!-- markdownlint-disable MD051 -->
<!-- filepath: /Users/ctyeh/Documents/NewsLeopard/nlm-codes/nlInc-vpnMgmtTools/vpn_connection_manual.md -->
# ğŸ“– AWS Client VPN é›™ç’°å¢ƒç®¡ç†å·¥å…·å¥—ä»¶å®Œæ•´ä½¿ç”¨æ‰‹å†Š

**ç‰ˆæœ¬ï¼š** 2.1
**é©ç”¨æ–¼ï¼š** macOS ä½¿ç”¨è€…åŠç®¡ç†å“¡
**æ›´æ–°æ—¥æœŸï¼š** YYYYå¹´MMæœˆDDæ—¥

---

## ğŸ“‹ ç›®éŒ„

1.  [å¼•è¨€](#å¼•è¨€)
    1.  [æ‰‹å†Šæ¦‚è¿°](#æ‰‹å†Šæ¦‚è¿°)
    2.  [2.0 ç‰ˆæœ¬æ–°ç‰¹æ€§](#20-ç‰ˆæœ¬æ–°ç‰¹æ€§)
    3.  [é‡è¦æé†’](#é‡è¦æé†’)
2.  [ç³»çµ±æ¶æ§‹](#ç³»çµ±æ¶æ§‹)
    1.  [é›™ç’°å¢ƒæ¶æ§‹ä»‹ç´¹](#é›™ç’°å¢ƒæ¶æ§‹ä»‹ç´¹)
    2.  [å·¥å…·çµ„ä»¶æ¦‚è¦½](#å·¥å…·çµ„ä»¶æ¦‚è¦½)
    3.  [å‡½å¼åº«æ¶æ§‹](#å‡½å¼åº«æ¶æ§‹)
3.  [åˆå§‹è¨­ç½® (ç®¡ç†å“¡)](#åˆå§‹è¨­ç½®-ç®¡ç†å“¡)
    1.  [ç³»çµ±è¦æ±‚](#ç³»çµ±è¦æ±‚)
    2.  [ä¸‹è¼‰å’Œæº–å‚™](#ä¸‹è¼‰å’Œæº–å‚™)
    3.  [é¦–æ¬¡ AWS é…ç½®](#é¦–æ¬¡-aws-é…ç½®)
    4.  [é©—è­‰è¨­ç½®](#é©—è­‰è¨­ç½®)
4.  [ç’°å¢ƒç®¡ç†å·¥å…·è©³è§£](#ç’°å¢ƒç®¡ç†å·¥å…·è©³è§£)
    1.  [`vpn_env.sh` - ç’°å¢ƒç®¡ç†å…¥å£](#vpn_envsh---ç’°å¢ƒç®¡ç†å…¥å£)
    2.  [`enhanced_env_selector.sh` - äº’å‹•å¼ç’°å¢ƒé¸æ“‡å™¨](#enhanced_env_selectorsh---äº’å‹•å¼ç’°å¢ƒé¸æ“‡å™¨)
5.  [ç”¨æˆ¶ VPN è¨­å®šèˆ‡é€£æ¥](#ç”¨æˆ¶-vpn-è¨­å®šèˆ‡é€£æ¥)
    1.  [å‰ç½®ä½œæ¥­æª¢æŸ¥ (ç”¨æˆ¶ç«¯)](#å‰ç½®ä½œæ¥­æª¢æŸ¥-ç”¨æˆ¶ç«¯)
    2.  [AWS VPN Client å®‰è£èˆ‡è¨­å®š](#aws-vpn-client-å®‰è£èˆ‡è¨­å®š)
    3.  [`team_member_setup.sh` - åœ˜éšŠæˆå“¡è¨­ç½®å·¥å…· (ç”¨æˆ¶ç«¯ä½¿ç”¨)](#team_member_setupsh---åœ˜éšŠæˆå“¡è¨­ç½®å·¥å…·-ç”¨æˆ¶ç«¯ä½¿ç”¨)
    4.  [VPN é€£æ¥æ­¥é©Ÿ (ç’°å¢ƒæ„ŸçŸ¥)](#vpn-é€£æ¥æ­¥é©Ÿ-ç’°å¢ƒæ„ŸçŸ¥)
    5.  [é€£æ¥é©—è­‰](#é€£æ¥é©—è­‰)
6.  [ç®¡ç†å“¡å·¥å…·è©³ç´°æŒ‡å—](#ç®¡ç†å“¡å·¥å…·è©³ç´°æŒ‡å—)
    1.  [`aws_vpn_admin.sh` - ç®¡ç†å“¡ä¸»æ§å°](#aws_vpn_adminsh---ç®¡ç†å“¡ä¸»æ§å°)
    2.  [`revoke_member_access.sh` - æ¬Šé™æ’¤éŠ·å·¥å…·](#revoke_member_accesssh---æ¬Šé™æ’¤éŠ·å·¥å…·)
    3.  [`employee_offboarding.sh` - é›¢è·è™•ç†ç³»çµ±](#employee_offboardingsh---é›¢è·è™•ç†ç³»çµ±)
7.  [æ—¥å¸¸æ“ä½œæŒ‡å—](#æ—¥å¸¸æ“ä½œæŒ‡å—)
    1.  [é›™ç’°å¢ƒæ—¥å¸¸å·¥ä½œæµç¨‹](#é›™ç’°å¢ƒæ—¥å¸¸å·¥ä½œæµç¨‹)
    2.  [ç’°å¢ƒåˆ‡æ›æ“ä½œè©³è§£](#ç’°å¢ƒåˆ‡æ›æ“ä½œè©³è§£)
8.  [æª”æ¡ˆç³»çµ±å½±éŸ¿](#æª”æ¡ˆç³»çµ±å½±éŸ¿)
    1.  [`aws_vpn_admin.sh` çš„æª”æ¡ˆå½±éŸ¿](#aws_vpn_adminsh-çš„æª”æ¡ˆå½±éŸ¿)
    2.  [`team_member_setup.sh` çš„æª”æ¡ˆå½±éŸ¿](#team_member_setupsh-çš„æª”æ¡ˆå½±éŸ¿)
    3.  [`revoke_member_access.sh` çš„æª”æ¡ˆå½±éŸ¿](#revoke_member_accesssh-çš„æª”æ¡ˆå½±éŸ¿)
    4.  [`employee_offboarding.sh` çš„æª”æ¡ˆå½±éŸ¿](#employee_offboardingsh-çš„æª”æ¡ˆå½±éŸ¿)
    5.  [æª”æ¡ˆæ¬Šé™å’Œå®‰å…¨è¨­å®š](#æª”æ¡ˆæ¬Šé™å’Œå®‰å…¨è¨­å®š)
9.  [ç¶­è­·å’Œç›£æ§](#ç¶­è­·å’Œç›£æ§)
    1.  [å®šæœŸç¶­è­·ä»»å‹™](#å®šæœŸç¶­è­·ä»»å‹™)
    2.  [è‡ªå‹•åŒ–ç›£æ§ç¯„ä¾‹](#è‡ªå‹•åŒ–ç›£æ§ç¯„ä¾‹)
10. [å®‰å…¨æœ€ä½³å¯¦è¸](#å®‰å…¨æœ€ä½³å¯¦è¸)
    1.  [é›™ç’°å¢ƒå®‰å…¨åŸå‰‡](#é›™ç’°å¢ƒå®‰å…¨åŸå‰‡)
    2.  [è­‰æ›¸å®‰å…¨ç®¡ç†](#è­‰æ›¸å®‰å…¨ç®¡ç†)
    3.  [è¨ªå•æ§åˆ¶](#è¨ªå•æ§åˆ¶)
    4.  [é…ç½®æ–‡ä»¶å®‰å…¨](#é…ç½®æ–‡ä»¶å®‰å…¨)
    5.  [VPN ä½¿ç”¨å®‰å…¨](#vpn-ä½¿ç”¨å®‰å…¨)
    6.  [äº‹ä»¶éŸ¿æ‡‰](#äº‹ä»¶éŸ¿æ‡‰)
11. [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)
    1.  [é›™ç’°å¢ƒç›¸é—œå•é¡Œ](#é›™ç’°å¢ƒç›¸é—œå•é¡Œ-1)
    2.  [ç®¡ç†å·¥å…·å¸¸è¦‹å•é¡Œ](#ç®¡ç†å·¥å…·å¸¸è¦‹å•é¡Œ)
    3.  [ç”¨æˆ¶ç«¯é€£æ¥å¸¸è¦‹å•é¡Œ](#ç”¨æˆ¶ç«¯é€£æ¥å¸¸è¦‹å•é¡Œ)
    4.  [æ—¥èªŒæ–‡ä»¶åˆ†æ](#æ—¥èªŒæ–‡ä»¶åˆ†æ)
12. [AWS è³‡æºå’Œæˆæœ¬ç®¡ç†](#aws-è³‡æºå’Œæˆæœ¬ç®¡ç†)
    1.  [å‰µå»ºçš„ AWS è³‡æº](#å‰µå»ºçš„-aws-è³‡æº)
    2.  [æˆæœ¬å„ªåŒ–å»ºè­°](#æˆæœ¬å„ªåŒ–å»ºè­°)
13. [å®Œæ•´ç§»é™¤æŒ‡å—](#å®Œæ•´ç§»é™¤æŒ‡å—)
    1.  [åœæ­¢æ‰€æœ‰æœå‹™](#åœæ­¢æ‰€æœ‰æœå‹™)
    2.  [ä½¿ç”¨å·¥å…·æ¸…ç† AWS è³‡æº](#ä½¿ç”¨å·¥å…·æ¸…ç†-aws-è³‡æº)
    3.  [æ¸…ç†æœ¬åœ°æ–‡ä»¶](#æ¸…ç†æœ¬åœ°æ–‡ä»¶)
    4.  [ç§»é™¤æ‡‰ç”¨ç¨‹å¼](#ç§»é™¤æ‡‰ç”¨ç¨‹å¼)
14. [é™„éŒ„](#é™„éŒ„)
    1.  [å¸¸ç”¨ AWS CLI å‘½ä»¤](#å¸¸ç”¨-aws-cli-å‘½ä»¤)
    2.  [é…ç½®æ–‡ä»¶ç¯„ä¾‹ (`.vpn_config`)](#é…ç½®æ–‡ä»¶ç¯„ä¾‹-vpn_config)
    3.  [IAM æ¬Šé™æ”¿ç­–ç¯„ä¾‹](#iam-æ¬Šé™æ”¿ç­–ç¯„ä¾‹)
    4.  [ç·Šæ€¥è¯çµ¡ç¯„æœ¬](#ç·Šæ€¥è¯çµ¡ç¯„æœ¬)
15. [å¸¸è¦‹å•é¡Œ FAQ](#å¸¸è¦‹å•é¡Œ-faq)
16. [ç·Šæ€¥è¯çµ¡è³‡è¨Š](#ç·Šæ€¥è¯çµ¡è³‡è¨Š)

---

## 1. å¼•è¨€

### 1.1 æ‰‹å†Šæ¦‚è¿°

æœ¬æ‰‹å†Šç‚º AWS Client VPN é›™ç’°å¢ƒç®¡ç†å·¥å…·å¥—ä»¶çš„å®Œæ•´ä½¿ç”¨èªªæ˜ï¼Œæ—¨åœ¨æŒ‡å°**ä¸€èˆ¬ä½¿ç”¨è€…**å¦‚ä½•å®‰å…¨é€£æ¥è‡³ Stagingï¼ˆæ¸¬è©¦ï¼‰å’Œ Productionï¼ˆç”Ÿç”¢ï¼‰ç’°å¢ƒï¼Œä¸¦ç‚º**ç®¡ç†å“¡**æä¾›å·¥å…·å¥—ä»¶çš„å®‰è£ã€é…ç½®ã€ç®¡ç†åŠç¶­è­·æŒ‡å—ã€‚æ–°ç³»çµ±å¼·èª¿ç’°å¢ƒéš”é›¢ã€å®‰å…¨ç®¡ç†åŠæ“ä½œä¾¿æ·æ€§ï¼Œæ—¨åœ¨ç‚ºä¼æ¥­æä¾›ä¸€å€‹å¯é ä¸”æ˜“æ–¼æ“´å±•çš„ VPN ç®¡ç†æ¡†æ¶ã€‚

é€éé›™ç’°å¢ƒè¨­è¨ˆï¼Œä¼æ¥­èƒ½å¤ åœ¨ Staging ç’°å¢ƒä¸­å®‰å…¨åœ°é€²è¡Œæ¸¬è©¦ã€é–‹ç™¼å’Œé…ç½®é©—è­‰ï¼Œè€Œ Production ç’°å¢ƒå‰‡ä¿æŒç©©å®šé‹è¡Œï¼Œæœå‹™æ–¼æ­£å¼çš„æ¥­å‹™éœ€æ±‚ã€‚é€™ç¨®åˆ†é›¢ç¢ºä¿äº†ç”Ÿç”¢ç³»çµ±çš„ç©©å®šæ€§ï¼ŒåŒæ™‚ç‚ºæ–°åŠŸèƒ½å’Œè®Šæ›´æä¾›äº†å®‰å…¨çš„æ¸¬è©¦å¹³å°ã€‚

### 1.2 2.0 ç‰ˆæœ¬æ–°ç‰¹æ€§

- âœ¨ **é›™ç’°å¢ƒæ”¯æ´** - å®Œå…¨åˆ†é›¢çš„ Staging å’Œ Production ç’°å¢ƒã€‚
- ğŸ”„ **æ™ºèƒ½ç’°å¢ƒåˆ‡æ›** - ä¸€éµåˆ‡æ›ä¸åŒç’°å¢ƒé…ç½® (`vpn_env.sh`, `enhanced_env_selector.sh`)ã€‚
- ğŸ›¡ï¸ **å¢å¼·å®‰å…¨ç¢ºèª** - Production ç’°å¢ƒæ“ä½œéœ€è¦å¤šé‡ç¢ºèªã€‚
- ğŸ“Š **ç’°å¢ƒå¥åº·ç›£æ§** - å³æ™‚ç›£æ§å…©å€‹ç’°å¢ƒçš„é‹è¡Œç‹€æ…‹ã€‚
- ğŸ¯ **ç’°å¢ƒæ¯”è¼ƒå·¥å…·** - å¿«é€Ÿæ¯”è¼ƒä¸åŒç’°å¢ƒçš„é…ç½®å·®ç•° (é€é `enhanced_env_selector.sh`)ã€‚

### 1.3 é‡è¦æé†’

- **Staging ç’°å¢ƒ**: ç”¨æ–¼é–‹ç™¼æ¸¬è©¦ã€åŠŸèƒ½é©—è­‰ã€æ–°åŠŸèƒ½é™¤éŒ¯ã€‚
- **Production ç’°å¢ƒ**: åƒ…ç”¨æ–¼ç”Ÿç”¢ç’°å¢ƒé™¤éŒ¯å’Œç·Šæ€¥ç¶­è­·ã€‚
- è«‹ä¾æ“šå·¥ä½œæ€§è³ªé¸æ“‡é©ç•¶çš„ç’°å¢ƒã€‚
- ä½¿ç”¨å®Œç•¢å¾Œç«‹å³æ–·é–‹é€£æ¥ã€‚
- åš´ç¦åˆ†äº«æ‚¨çš„ VPN é…ç½®æ–‡ä»¶æˆ–æ†‘è­‰ã€‚
- ç®¡ç†å“¡æ‡‰å¦¥å–„ä¿ç®¡ CA é‡‘é‘°åŠç›¸é—œæ•æ„Ÿé…ç½®ã€‚

---

## 2. ç³»çµ±æ¶æ§‹

### 2.1 é›™ç’°å¢ƒæ¶æ§‹ä»‹ç´¹

æœ¬å·¥å…·å¥—ä»¶æ”¯æ´å®Œå…¨åˆ†é›¢çš„é›™ç’°å¢ƒæ¶æ§‹ï¼Œç¢ºä¿é–‹ç™¼æ¸¬è©¦èˆ‡ç”Ÿç”¢æ“ä½œçš„ç¨ç«‹æ€§ã€‚é—œéµè³‡æºå¦‚é…ç½®æ–‡ä»¶ã€è­‰æ›¸å’Œæ—¥èªŒå‡æŒ‰ç’°å¢ƒå­˜æ”¾ï¼š

```bash
configs/
â”œâ”€â”€ staging/                 # ğŸŸ¡ Staging ç’°å¢ƒé…ç½®
â”‚   â””â”€â”€ staging.env
â””â”€â”€ production/             # ğŸ”´ Production ç’°å¢ƒé…ç½®
    â””â”€â”€ production.env

certs/
â”œâ”€â”€ staging/                # Staging ç’°å¢ƒè­‰æ›¸
â””â”€â”€ production/             # Production ç’°å¢ƒè­‰æ›¸

logs/
â”œâ”€â”€ staging/                # Staging ç’°å¢ƒæ—¥èªŒ
â””â”€â”€ production/             # Production ç’°å¢ƒæ—¥èªŒ
```

**ç’°å¢ƒç‰¹æ€§:**

#### Staging ç’°å¢ƒ ğŸŸ¡
- **ç”¨é€”**: é–‹ç™¼ã€æ¸¬è©¦ã€å¯¦é©—ã€‚
- **å®‰å…¨ç´šåˆ¥**: æ¨™æº–ã€‚
- **ç¢ºèªè¦æ±‚**: åŸºæœ¬ç¢ºèªã€‚
- **é©ç”¨å°è±¡**: é–‹ç™¼åœ˜éšŠã€QA åœ˜éšŠã€‚

#### Production ç’°å¢ƒ ğŸ”´
- **ç”¨é€”**: ç”Ÿç”¢ç’°å¢ƒã€æ­£å¼æœå‹™ã€‚
- **å®‰å…¨ç´šåˆ¥**: æœ€é«˜ã€‚
- **ç¢ºèªè¦æ±‚**: å¤šé‡ç¢ºèªã€è¼¸å…¥é©—è­‰ã€‚
- **é©ç”¨å°è±¡**: é‹ç¶­åœ˜éšŠã€è³‡æ·±å·¥ç¨‹å¸«ã€‚

### 2.2 å·¥å…·çµ„ä»¶æ¦‚è¦½

1.  **`vpn_env.sh`** - ğŸ†• ç’°å¢ƒç®¡ç†å…¥å£ï¼ˆæ–°å¢ï¼‰ã€‚
2.  **`enhanced_env_selector.sh`** - ğŸ†• å¢å¼·ç’°å¢ƒé¸æ“‡å™¨ï¼ˆæ–°å¢ï¼‰ã€‚
3.  **`aws_vpn_admin.sh`** - ç®¡ç†å“¡ä¸»æ§å°ï¼ˆæ ¸å¿ƒç®¡ç†å·¥å…·ï¼‰ã€‚
4.  **`team_member_setup.sh`** - åœ˜éšŠæˆå“¡è¨­ç½®å·¥å…·ã€‚
5.  **`revoke_member_access.sh`** - æ¬Šé™æ’¤éŠ·å·¥å…·ã€‚
6.  **`employee_offboarding.sh`** - é›¢è·è™•ç†ç³»çµ±ã€‚

### 2.3 å‡½å¼åº«æ¶æ§‹

æœ¬å·¥å…·å¥—ä»¶æ¡ç”¨æ¨¡çµ„åŒ–å‡½å¼åº«è¨­è¨ˆï¼Œæ ¸å¿ƒåŠŸèƒ½åˆ†ä½ˆæ–¼ `lib/` ç›®éŒ„ä¸‹ï¼š
```bash
lib/
â”œâ”€â”€ core_functions.sh        # æ ¸å¿ƒå‡½å¼å’Œé€šç”¨å·¥å…· (æ—¥èªŒ, é©—è­‰ç­‰)
â”œâ”€â”€ env_manager.sh          # ğŸ†• ç’°å¢ƒç®¡ç†æ ¸å¿ƒåŠŸèƒ½ (åˆ‡æ›, ç‹€æ…‹, å¥åº·æª¢æŸ¥)
â”œâ”€â”€ enhanced_confirmation.sh # ğŸ†• å¢å¼·ç¢ºèªç³»çµ± (ç”¨æ–¼ Production ç’°å¢ƒæ“ä½œ)
â”œâ”€â”€ aws_setup.sh            # AWS CLI é…ç½®å’Œé©—è­‰ç›¸é—œå‡½å¼
â”œâ”€â”€ cert_management.sh      # Easy-RSA æ†‘è­‰ç”Ÿæˆå’Œç®¡ç†å‡½å¼
â”œâ”€â”€ endpoint_creation.sh    # AWS Client VPN ç«¯é»å‰µå»ºå’Œé…ç½®å‡½å¼
â””â”€â”€ endpoint_management.sh  # ç«¯é»é—œè¯ã€æˆæ¬Šã€è·¯ç”±ç­‰ç®¡ç†å‡½å¼
```

---

## 3. åˆå§‹è¨­ç½® (ç®¡ç†å“¡)

æœ¬ç« ç¯€æŒ‡å°ç®¡ç†å“¡å®Œæˆå·¥å…·å¥—ä»¶çš„åˆå§‹éƒ¨ç½²å’Œé…ç½®ã€‚

### 3.1 ç³»çµ±è¦æ±‚

#### ç¡¬é«”è¦æ±‚
- macOS 10.15+ (Catalina æˆ–æ›´æ–°ç‰ˆæœ¬)
- è‡³å°‘ 4GB RAM
- 2GB å¯ç”¨ç£ç¢Ÿç©ºé–“
- ç©©å®šçš„ç¶²è·¯é€£æ¥

#### è»Ÿé«”ä¾è³´
æœ¬å¥—ä»¶æœƒè‡ªå‹•å˜—è©¦å®‰è£ä»¥ä¸‹å·¥å…·ï¼ˆè‹¥å°šæœªå®‰è£ï¼‰ï¼š
- **Homebrew** - macOS å¥—ä»¶ç®¡ç†å™¨ (ç”¨æ–¼å®‰è£å…¶ä»–ä¾è³´)
- **AWS CLI** - AWS å‘½ä»¤åˆ—å·¥å…·
- **jq** - JSON è™•ç†å·¥å…·
- **Easy-RSA** - è­‰æ›¸ç®¡ç†å·¥å…· (é€šå¸¸éš¨ OpenVPN æˆ–å¯ç¨ç«‹å®‰è£)
- **OpenSSL** - åŠ å¯†å·¥å…· (macOS é€šå¸¸å…§å»º)

#### AWS æ¬Šé™è¦æ±‚
é‹è¡Œæœ¬å·¥å…·å¥—ä»¶ä¸­çš„ä¸åŒè…³æœ¬éœ€è¦ç‰¹å®šçš„ AWS IAM æ¬Šé™ã€‚è©³ç´°çš„ JSON æ”¿ç­–ç¯„ä¾‹è«‹åƒé–± [é™„éŒ„ 14.3 IAM æ¬Šé™æ”¿ç­–ç¯„ä¾‹](#iam-æ¬Šé™æ”¿ç­–ç¯„ä¾‹)ã€‚
- **ç®¡ç†å“¡æ¬Šé™ (`aws_vpn_admin.sh`)**: éœ€è¦ç®¡ç† Client VPN ç«¯é»ã€ACM è­‰æ›¸ã€æ—¥èªŒã€VPC å’Œå­ç¶²è·¯ç­‰è³‡æºçš„æ¬Šé™ã€‚
- **åœ˜éšŠæˆå“¡è¨­ç½®æ¬Šé™ (`team_member_setup.sh` ç”±ç®¡ç†å“¡æº–å‚™åŸºç¤æ–‡ä»¶æ™‚å¯èƒ½é–“æ¥ä½¿ç”¨éƒ¨åˆ†æ¬Šé™ï¼Œç”¨æˆ¶ç«¯åŸ·è¡Œæ™‚ä¹Ÿéœ€è¦æ¬Šé™)**: éœ€è¦æè¿° VPN ç«¯é»ã€å°å‡ºå®¢æˆ¶ç«¯é…ç½®ã€ä»¥åŠç®¡ç†å€‹äºº ACM è­‰æ›¸çš„æ¬Šé™ã€‚
- **é«˜æ¬Šé™æ“ä½œ (`employee_offboarding.sh`)**: å¯èƒ½éœ€è¦æ›´å»£æ³›çš„æ¬Šé™ï¼Œä¾‹å¦‚ IAM ç®¡ç†ã€S3 å­˜å–ç­‰ã€‚

### 3.2 ä¸‹è¼‰å’Œæº–å‚™

1.  **ç²å–å·¥å…·å¥—ä»¶**:
    é€šå¸¸ç”±é–‹ç™¼åœ˜éšŠæä¾›å£“ç¸®æª”æˆ– Git å„²å­˜åº«å­˜å–æ¬Šé™ã€‚

2.  **å‰µå»ºå·¥ä½œç›®éŒ„**:
    ```bash
    mkdir -p ~/aws-vpn-tools
    cd ~/aws-vpn-tools
    ```

3.  **è§£å£“æˆ–è¤‡è£½æ–‡ä»¶**:
    ç¢ºä¿å·¥å…·å¥—ä»¶çš„æ–‡ä»¶çµæ§‹å¦‚ä¸‹ï¼š
    ```bash
    .
    â”œâ”€â”€ aws_vpn_admin.sh
    â”œâ”€â”€ employee_offboarding.sh
    â”œâ”€â”€ enhanced_env_selector.sh
    â”œâ”€â”€ readme.md
    â”œâ”€â”€ revoke_member_access.sh
    â”œâ”€â”€ team_member_setup.sh
    â”œâ”€â”€ vpn_connection_manual.md
    â”œâ”€â”€ vpn_env.sh
    â””â”€â”€ lib/
        â”œâ”€â”€ aws_setup.sh
        â”œâ”€â”€ cert_management.sh
        â”œâ”€â”€ core_functions.sh
        â”œâ”€â”€ endpoint_creation.sh
        â”œâ”€â”€ endpoint_management.sh
        â”œâ”€â”€ enhanced_confirmation.sh
        â””â”€â”€ env_manager.sh
    ```

4.  **è¨­ç½®åŸ·è¡Œæ¬Šé™**:
    ```bash
    chmod +x *.sh
    chmod +x lib/*.sh
    ```
    (æ³¨æ„: `readme.md` å’Œ `vpn_connection_manual.md` ä¸éœ€è¦åŸ·è¡Œæ¬Šé™)

### 3.3 é¦–æ¬¡ AWS é…ç½®

ç®¡ç†å“¡é¦–æ¬¡åŸ·è¡Œ `aws_vpn_admin.sh` æˆ–ä»»ä½•éœ€è¦ AWS äº’å‹•çš„è…³æœ¬æ™‚ï¼Œè‹¥å°šæœªé…ç½® AWS CLIï¼Œç³»çµ±æœƒå¼•å°é€²è¡Œé…ç½®ã€‚

```bash
# å»ºè­°å…ˆæ‰‹å‹•é…ç½® AWS CLIï¼Œç¢ºä¿æ¬Šé™æ­£ç¢º
aws configure
```
ç³»çµ±æœƒæç¤ºè¼¸å…¥ï¼š
- AWS Access Key ID
- AWS Secret Access Key
- Default region name (ä¾‹å¦‚ï¼šap-northeast-1)
- Default output format (å»ºè­°ï¼šjson)

æˆ–è€…ï¼Œè…³æœ¬ä¸­çš„ `lib/aws_setup.sh` æœƒæª¢æŸ¥ä¸¦æç¤ºé…ç½®ã€‚

### 3.4 é©—è­‰è¨­ç½®

1.  **é©—è­‰ AWS é…ç½®**:
    ```bash
    aws sts get-caller-identity
    ```
    å¦‚æœæˆåŠŸï¼Œæœƒé¡¯ç¤ºæ‚¨çš„å¸³æˆ¶ã€ç”¨æˆ¶ ID å’Œ ARNã€‚

2.  **æª¢æŸ¥ VPC è¨ªå•æ¬Šé™** (æ ¹æ“šæ‚¨è¨ˆåŠƒä½¿ç”¨çš„å€åŸŸ):
    ```bash
    aws ec2 describe-vpcs --region your-chosen-region
    ```

3.  **åˆå§‹åŒ–ç’°å¢ƒç®¡ç†ç³»çµ±** (é¦–æ¬¡ä½¿ç”¨å·¥å…·å¥—ä»¶å‰):
    ```bash
    ./vpn_env.sh init
    ```
    é€™å°‡å‰µå»ºå¿…è¦çš„é…ç½®æ–‡ä»¶ç›®éŒ„ (`configs/staging`, `configs/production`) å’Œå…¶ä»–æ”¯æŒæ€§çµæ§‹ã€‚

---

## 4. ç’°å¢ƒç®¡ç†å·¥å…·è©³è§£

æœ¬ç¯€è©³ç´°ä»‹ç´¹ç”¨æ–¼ç®¡ç† Staging å’Œ Production ç’°å¢ƒçš„å·¥å…·ã€‚

### 4.1 `vpn_env.sh` - ç’°å¢ƒç®¡ç†å…¥å£

`vpn_env.sh` æ˜¯ç®¡ç†å’Œåˆ‡æ› VPN ç’°å¢ƒçš„ä¸»è¦å‘½ä»¤åˆ—å·¥å…·ã€‚

#### åŸºæœ¬æ“ä½œ

1.  **æŸ¥çœ‹ç•¶å‰ç’°å¢ƒç‹€æ…‹ (`status`)**
    ```bash
    ./vpn_env.sh status
    ```
    è¼¸å‡ºç¯„ä¾‹ï¼š
    ```text
    === ç•¶å‰ VPN ç’°å¢ƒç‹€æ…‹ ===
    ç’°å¢ƒ: ğŸŸ¡ Staging Environment
    åç¨±: staging
    ç‹€æ…‹: ğŸŸ¢ å¥åº·
    é…ç½®æ–‡ä»¶: /path/to/configs/staging/staging.env
    ========================
    ```

2.  **åˆ‡æ›ç’°å¢ƒ (`switch`)**
    - **åˆ‡æ›åˆ° Staging ç’°å¢ƒ**:
      ```bash
      ./vpn_env.sh switch staging
      ```
      è¼¸å‡ºï¼š
      ```text
      ğŸ”„ ç’°å¢ƒå·²æˆåŠŸåˆ‡æ›åˆ° Staging
      ```
    - **åˆ‡æ›åˆ° Production ç’°å¢ƒ** (éœ€è¦é¡å¤–ç¢ºèª):
      ```bash
      ./vpn_env.sh switch production
      ```
      è¼¸å‡ºç¯„ä¾‹ï¼š
      ```text
      âš ï¸  Production ç’°å¢ƒåˆ‡æ›ç¢ºèª

      æ‚¨å³å°‡åˆ‡æ›åˆ°ç”Ÿç”¢ç’°å¢ƒï¼š
      â€¢ æ‰€æœ‰å¾ŒçºŒæ“ä½œå°‡å½±éŸ¿æ­£å¼ç³»çµ±
      â€¢ è«‹ç¢ºä¿æ‚¨æœ‰é©ç•¶çš„æ¬Šé™å’Œæˆæ¬Š
      â€¢ æ“ä½œå°‡è¢«è¨˜éŒ„åœ¨å¯©è¨ˆæ—¥èªŒä¸­

      ç¢ºèªåˆ‡æ›åˆ° Production ç’°å¢ƒï¼Ÿ [yes/NO]: yes
      âœ… ç’°å¢ƒå·²æˆåŠŸåˆ‡æ›åˆ° Production
      ```

3.  **æª¢æŸ¥ç’°å¢ƒå¥åº·ç‹€æ…‹ (`health`)**
    - **æª¢æŸ¥æ‰€æœ‰ç’°å¢ƒ**:
      ```bash
      ./vpn_env.sh health
      ```
      è¼¸å‡ºç¯„ä¾‹ï¼š
      ```text
      === ç’°å¢ƒå¥åº·ç‹€æ…‹æª¢æŸ¥ ===
      staging: ğŸŸ¢ å¥åº· (100% æ­£å¸¸)
      production: ğŸŸ¡ è­¦å‘Š (è­‰æ›¸å³å°‡åˆ°æœŸ)
      ===========================
      ```
    - **æª¢æŸ¥ç‰¹å®šç’°å¢ƒ**:
      ```bash
      ./vpn_env.sh health staging
      ```

4.  **å•Ÿå‹•äº’å‹•å¼é¸æ“‡å™¨ (`selector`)**
    ```bash
    ./vpn_env.sh selector
    ```
    é€™å°‡å•Ÿå‹• `enhanced_env_selector.sh`ã€‚

5.  **åˆå§‹åŒ–ç’°å¢ƒé…ç½® (`init`)** (ä¸»è¦ä¾›é¦–æ¬¡è¨­å®šæˆ–ä¿®å¾©ä½¿ç”¨)
    ```bash
    ./vpn_env.sh init
    ```
    æ­¤å‘½ä»¤æœƒå‰µå»º `configs/staging/staging.env` å’Œ `configs/production/production.env` çš„åŸºç¤æ¨¡æ¿ï¼ˆå¦‚æœå®ƒå€‘ä¸å­˜åœ¨ï¼‰ï¼Œä»¥åŠç›¸é—œçš„ `certs` å’Œ `logs` ç›®éŒ„çµæ§‹ã€‚

### 4.2 `enhanced_env_selector.sh` - äº’å‹•å¼ç’°å¢ƒé¸æ“‡å™¨

æä¾›ä¸€å€‹èœå–®é©…å‹•çš„ç•Œé¢ä¾†ç®¡ç† VPN ç’°å¢ƒã€‚

```bash
# å•Ÿå‹•äº’å‹•å¼ç’°å¢ƒç®¡ç†æ§åˆ¶å°
./enhanced_env_selector.sh
```

**æ§åˆ¶å°ç•Œé¢é è¦½:**
```text
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘               AWS Client VPN å¤šç’°å¢ƒç®¡ç†æ§åˆ¶å° v2.0               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ç•¶å‰ç’°å¢ƒ: ğŸŸ¡ Staging Environment (ğŸŸ¢ å¥åº·)

å¯ç”¨ç’°å¢ƒ:
  1. ğŸŸ¡ Staging    - é–‹ç™¼æ¸¬è©¦ç’°å¢ƒ â† ç•¶å‰
     å¥åº·ç‹€æ…‹: ğŸŸ¢ å¥åº· (100%)  æ´»èºé€£ç·š: 3 å€‹
     
  2. ğŸ”´ Production - ç”Ÿç”¢ç‡Ÿé‹ç’°å¢ƒ
     å¥åº·ç‹€æ…‹: ğŸŸ¡ è­¦å‘Š (85%)   æ´»èºé€£ç·š: 8 å€‹

å¿«é€Ÿæ“ä½œ:
  [E] åˆ‡æ›ç’°å¢ƒ    [S] ç’°å¢ƒç‹€æ…‹    [H] å¥åº·æª¢æŸ¥
  [D] è©³ç´°è³‡è¨Š    [C] ç’°å¢ƒæ¯”è¼ƒ    [R] é‡æ–°æ•´ç†
  [Q] é€€å‡º

è«‹é¸æ“‡ç’°å¢ƒæˆ–æ“ä½œ [1-2/E/S/H/D/C/R/Q]:
```

**åŠŸèƒ½èªªæ˜:**
- **[E] åˆ‡æ›ç’°å¢ƒ**: äº’å‹•å¼ç’°å¢ƒåˆ‡æ›ï¼Œåˆ° Production ç’°å¢ƒæ™‚æœƒæœ‰å®‰å…¨ç¢ºèªã€‚
- **[S] ç’°å¢ƒç‹€æ…‹**: æŸ¥çœ‹ç•¶å‰é¸æ“‡ç’°å¢ƒçš„è©³ç´°è³‡è¨Šå’Œå¥åº·ç‹€æ…‹ã€‚
- **[H] å¥åº·æª¢æŸ¥**: æª¢æŸ¥æ‰€æœ‰å·²é…ç½®ç’°å¢ƒçš„å¥åº·ç‹€æ…‹ï¼ŒåŒ…å«è©³ç´°è¨ºæ–·ã€‚
- **[D] è©³ç´°è³‡è¨Š**: é¡¯ç¤ºé¸å®šç’°å¢ƒçš„å®Œæ•´é…ç½®è³‡è¨Š (å¾ `.env` æ–‡ä»¶è®€å–)ã€‚
- **[C] ç’°å¢ƒæ¯”è¼ƒ**: (å¦‚æœå¯¦ç¾) æ¯”è¼ƒ Staging å’Œ Production ç’°å¢ƒçš„é—œéµé…ç½®åƒæ•¸å·®ç•°ã€‚
- **[R] é‡æ–°æ•´ç†**: æ›´æ–°é¡¯ç¤ºçš„ç’°å¢ƒç‹€æ…‹è³‡è¨Šã€‚
- **[Q] é€€å‡º**: é›¢é–‹æ§åˆ¶å°ã€‚

---

## 5. ç”¨æˆ¶ VPN è¨­å®šèˆ‡é€£æ¥

æœ¬ç« ç¯€ä¸»è¦ç‚ºä¸€èˆ¬ä½¿ç”¨è€…æä¾› VPN é€£æ¥æŒ‡å—ã€‚

### 5.1 å‰ç½®ä½œæ¥­æª¢æŸ¥ (ç”¨æˆ¶ç«¯)

åœ¨åœ˜éšŠæˆå“¡é–‹å§‹ä½¿ç”¨ `team_member_setup.sh` ä¹‹å‰ï¼Œç®¡ç†å“¡æ‡‰æä¾›ä»¥ä¸‹æ–‡ä»¶/ä¿¡æ¯ï¼š
1.  `team_member_setup.sh` è…³æœ¬æœ¬èº«ã€‚
2.  `ca.crt` (CA è­‰æ›¸) æ–‡ä»¶ï¼Œæ­¤æ–‡ä»¶æ‡‰èˆ‡ç›®æ¨™ VPN ç’°å¢ƒ (Staging/Production) çš„ä¼ºæœå™¨è­‰æ›¸å°æ‡‰ã€‚ç®¡ç†å“¡å¯å¾ `certs/[environment]/ca.crt` (åœ¨ç®¡ç†å“¡æ©Ÿå™¨ä¸Šç”Ÿæˆå¾Œ) æˆ– `team-configs/ca.crt` (ç”± `aws_vpn_admin.sh` å°å‡ºåœ˜éšŠé…ç½®æ™‚ç”Ÿæˆ) ç²å–ã€‚
3.  ç›®æ¨™ç’°å¢ƒçš„ VPN ç«¯é» ID (Client VPN Endpoint ID)ã€‚

ä½¿ç”¨è€…æ‡‰å°‡ `team_member_setup.sh` å’Œ `ca.crt` æ”¾ç½®åœ¨åŒä¸€å€‹ç›®éŒ„ä¸‹ã€‚

åŸ·è¡Œå®Œ `team_member_setup.sh` å¾Œï¼Œç”¨æˆ¶çš„å°ˆæ¡ˆç›®éŒ„æ‡‰åŒ…å«é‡å°å…¶å€‹äººå’Œé¸å®šç’°å¢ƒçš„é…ç½®ï¼š
```bash
æ‚¨çš„å·¥ä½œç›®éŒ„/
â”œâ”€â”€ team_member_setup.sh
â”œâ”€â”€ ca.crt                          # ç”±ç®¡ç†å“¡æä¾›
â”œâ”€â”€ .user_vpn_config                # ç”¨æˆ¶é…ç½® (æ•æ„Ÿ)
â”œâ”€â”€ user_vpn_setup.log              # ç”¨æˆ¶è¨­ç½®æ—¥èªŒ
â”œâ”€â”€ user-certificates/              # ç”¨æˆ¶è­‰æ›¸ç›®éŒ„ (é«˜åº¦æ•æ„Ÿ)
â”‚   â”œâ”€â”€ [username].crt              # ç”¨æˆ¶è­‰æ›¸
â”‚   â””â”€â”€ [username].key              # ç”¨æˆ¶ç§é‘° (æ¥µåº¦æ•æ„Ÿ)
â””â”€â”€ vpn-config/                     # VPN é…ç½®æª”æ¡ˆ
    â””â”€â”€ [username]-[environment]-config.ovpn # å€‹äºº VPN é…ç½® (å«ç§é‘°)
```
(æ³¨æ„: æ–°ç‰ˆé›™ç’°å¢ƒç”¨æˆ¶ç«¯å·¥å…·å¯èƒ½ç›´æ¥æ•´åˆç’°å¢ƒé¸æ“‡ï¼Œç›®éŒ„çµæ§‹è«‹ä»¥å¯¦éš›è…³æœ¬è¼¸å‡ºç‚ºæº–)

### 5.2 AWS VPN Client å®‰è¼¸èˆ‡è¨­å®š

(æ­¤éƒ¨åˆ†å…§å®¹åŸºæœ¬èˆ‡ `vpn_connection_manual.md` v2.0 ç‰ˆæœ¬ä¸€è‡´ï¼Œæ­¤è™•åƒ…ä½œçµæ§‹èª¿æ•´ç¢ºèª)

#### æ­¥é©Ÿ 1ï¼šç¢ºèª AWS VPN Client å·²å®‰è£
æª¢æŸ¥ `/Applications/AWS VPN Client.app` æ˜¯å¦å­˜åœ¨ã€‚è‹¥ç„¡ï¼Œè«‹å¾ AWS å®˜æ–¹ç¶²ç«™ä¸‹è¼‰ä¸¦å®‰è£ã€‚

#### æ­¥é©Ÿ 2ï¼šå•Ÿå‹• AWS VPN Client
å¯é€é Spotlight, Finder æˆ– Launchpad å•Ÿå‹•ã€‚

#### æ­¥é©Ÿ 3ï¼šé¦–æ¬¡å•Ÿå‹•è¨­å®š
è™•ç† macOS å®‰å…¨æç¤ºåŠæ‡‰ç”¨ç¨‹å¼è¨±å¯ã€‚

### 5.3 `team_member_setup.sh` - åœ˜éšŠæˆå“¡è¨­ç½®å·¥å…· (ç”¨æˆ¶ç«¯ä½¿ç”¨)

æ­¤å·¥å…·æ—¨åœ¨ç°¡åŒ–åœ˜éšŠæˆå“¡ç²å–å’Œé…ç½®å…¶å€‹äºº VPN å®¢æˆ¶ç«¯æ‰€éœ€çš„è­‰æ›¸å’Œ `.ovpn` é…ç½®æ–‡ä»¶ã€‚

**å‡è¨­ç®¡ç†å“¡å·²æä¾› `team_member_setup.sh` å’Œå°æ‡‰ç’°å¢ƒçš„ `ca.crt`ã€‚**

**ç”¨æˆ¶ç«¯åŸ·è¡Œæµç¨‹ï¼š**
1.  **å°‡ `team_member_setup.sh` å’Œ `ca.crt` æ”¾å…¥åŒä¸€ç›®éŒ„ã€‚**
2.  **é–‹å•Ÿçµ‚ç«¯æ©Ÿï¼Œ`cd`åˆ°è©²ç›®éŒ„ã€‚**
3.  **è³¦äºˆè…³æœ¬åŸ·è¡Œæ¬Šé™ï¼š**
    ```bash
    chmod +x team_member_setup.sh
    ```
4.  **åŸ·è¡Œè…³æœ¬ï¼š**
    ```bash
    ./team_member_setup.sh
    ```
5.  **éµå¾ªè…³æœ¬æç¤ºæ“ä½œï¼š**
    *   **é¸æ“‡ç›®æ¨™ç’°å¢ƒ**: è…³æœ¬å¯èƒ½æœƒæç¤ºé¸æ“‡ Staging æˆ– Productionã€‚
    *   **AWS é…ç½®**: å¯èƒ½æç¤ºè¼¸å…¥ AWS Access Key ID, Secret Access Key, Region (ç”¨æ–¼ä¸Šå‚³ç”¨æˆ¶è­‰æ›¸åˆ° ACM)ã€‚
    *   **ç”¨æˆ¶è³‡è¨Š**: è¼¸å…¥ç”¨æˆ¶å (ä¾‹å¦‚ `john.doe`) å’Œé›»å­éƒµä»¶ã€‚
    *   **è­‰æ›¸ç”Ÿæˆ**: è…³æœ¬æœƒåœ¨æœ¬åœ°ç”Ÿæˆç”¨æˆ¶çš„ç§é‘° (`.key`) å’Œè­‰æ›¸ (`.crt`)ã€‚
    *   **å°å…¥è­‰æ›¸åˆ° ACM**: è…³æœ¬æœƒå˜—è©¦å°‡ç”¨æˆ¶è­‰æ›¸ä¸Šå‚³åˆ° AWS Certificate Manager (ACM)ã€‚
    *   **ç”Ÿæˆ `.ovpn` é…ç½®æ–‡ä»¶**: è…³æœ¬æœƒä½¿ç”¨ç”¨æˆ¶è­‰æ›¸ã€ç§é‘°å’Œ `ca.crt` ç”Ÿæˆå€‹äººåŒ–çš„ `.ovpn` é…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚ `john.doe-staging-config.ovpn`ã€‚

**æˆåŠŸåŸ·è¡Œå¾Œï¼Œç”¨æˆ¶å°‡ç²å¾—ï¼š**
-   `user-certificates/` ç›®éŒ„ä¸‹çš„å€‹äººè­‰æ›¸å’Œç§é‘°ã€‚
-   `vpn-config/` ç›®éŒ„ä¸‹çš„å€‹äºº `.ovpn` é…ç½®æ–‡ä»¶ã€‚

ç”¨æˆ¶æ‡‰å¦¥å–„ä¿ç®¡é€™äº›æ–‡ä»¶ï¼Œå°¤å…¶æ˜¯ç§é‘°å’Œ `.ovpn` æ–‡ä»¶ã€‚

### 5.4 VPN é€£æ¥æ­¥é©Ÿ (ç’°å¢ƒæ„ŸçŸ¥)

(æ­¤éƒ¨åˆ†å…§å®¹åŸºæœ¬èˆ‡ `vpn_connection_manual.md` v2.0 ç‰ˆæœ¬ä¸€è‡´ï¼Œå¼·èª¿ç’°å¢ƒé¸æ“‡)

**é—œéµæ­¥é©Ÿï¼š**
1.  **ç¢ºèª/é¸æ“‡ç’°å¢ƒ**: (è‹¥ç”¨æˆ¶ç«¯å·¥å…·ä¸ç›´æ¥ç®¡ç†ç’°å¢ƒåˆ‡æ›) ä½¿ç”¨ç®¡ç†å“¡æä¾›çš„ `vpn_env.sh` (å¦‚æœé©ç”¨æ–¼ç”¨æˆ¶ç«¯) æˆ–æ ¹æ“šæŒ‡å°æ‰‹å‹•ç¢ºèªç›®æ¨™ç’°å¢ƒã€‚å°æ–¼ `team_member_setup.sh` ç”Ÿæˆçš„ç‰¹å®šç’°å¢ƒé…ç½®æ–‡ä»¶ï¼Œç”¨æˆ¶æ‡‰æ¸…æ¥šè‡ªå·±è¦é€£æ¥å“ªå€‹ç’°å¢ƒã€‚
2.  **é–‹å•Ÿè¨­å®šæª”ç®¡ç†**: åœ¨ AWS VPN Client ä¸­ `File > Manage Profiles`ã€‚
3.  **æ·»åŠ ç’°å¢ƒå°ˆç”¨è¨­å®šæª”**: é»æ“Š "Add Profile"ã€‚
4.  **é¸æ“‡ç’°å¢ƒå°ˆç”¨é…ç½®æª”æ¡ˆ**: å°èˆªåˆ° `vpn-config/` ä¸¦é¸æ“‡å°æ‡‰çš„ `[username]-[environment]-config.ovpn` æ–‡ä»¶ã€‚
5.  **è¨­å®šç’°å¢ƒè­˜åˆ¥è¨­å®šæª”**: å‘½åæ™‚æ˜ç¢ºæ¨™è¨»ç’°å¢ƒï¼Œä¾‹å¦‚ `Staging VPN - John Doe` æˆ– `Production VPN - John Doe`ã€‚
6.  **ç’°å¢ƒæ„ŸçŸ¥é€£æ¥**: é¸æ“‡æ­£ç¢ºçš„è¨­å®šæª”å¾Œé»æ“Š "Connect"ã€‚

### 5.5 é€£æ¥é©—è­‰

(æ­¤éƒ¨åˆ†å…§å®¹èˆ‡ `vpn_connection_manual.md` v2.0 ç‰ˆæœ¬ä¸€è‡´)
- ç¢ºèª AWS VPN Client ç‹€æ…‹ã€‚
- ç¶²è·¯é€£æ¥æ¸¬è©¦ (ifconfig, netstat, ping å…§éƒ¨è³‡æº)ã€‚
- DNS è§£ææ¸¬è©¦ã€‚

---

## 6. ç®¡ç†å“¡å·¥å…·è©³ç´°æŒ‡å—

æœ¬ç« ç¯€ç‚ºç®¡ç†å“¡æä¾›æ ¸å¿ƒç®¡ç†å·¥å…·çš„è©³ç´°ä½¿ç”¨èªªæ˜ã€‚**åŸ·è¡Œé€™äº›å·¥å…·å‰ï¼Œè«‹ä½¿ç”¨ `vpn_env.sh switch <environment>` åˆ‡æ›åˆ°ç›®æ¨™æ“ä½œç’°å¢ƒ (Staging æˆ– Production)ã€‚**

### 6.1 `aws_vpn_admin.sh` - ç®¡ç†å“¡ä¸»æ§å°

é€™æ˜¯æ ¸å¿ƒç®¡ç†å·¥å…·ï¼Œç”¨æ–¼å‰µå»ºã€ç®¡ç†å’Œç¶­è­· AWS Client VPN ç«¯é»åŠå…¶ç›¸é—œè³‡æºã€‚

**å•Ÿå‹•æ–¹å¼:**
```bash
# ç¢ºä¿å·²åˆ‡æ›åˆ°ç›®æ¨™ç’°å¢ƒ (staging/production)
./vpn_env.sh status # ç¢ºèªç•¶å‰ç’°å¢ƒ
./admin-tools/aws_vpn_admin.sh
```

**ä¸»è¦åŠŸèƒ½é¸å–® (ç¤ºä¾‹):**
1.  **å»ºç«‹æ–°çš„ VPN ç«¯é»**:
    *   å¼•å°ç®¡ç†å“¡å®Œæˆ VPN ç«¯é»çš„å‰µå»ºæµç¨‹ã€‚
    *   è‡ªå‹•è™•ç† CAã€ä¼ºæœå™¨ã€ç®¡ç†å“¡è­‰æ›¸çš„ç”Ÿæˆèˆ‡ ACM å°å…¥ (ä½¿ç”¨ `lib/cert_management.sh`)ã€‚
    *   é…ç½®ç¶²è·¯ (é¸æ“‡ VPCã€å­ç¶²è·¯)ã€DNS ä¼ºæœå™¨ã€åˆ†å‰²é€šé“ç­‰ (ä½¿ç”¨ `lib/endpoint_creation.sh`)ã€‚
    *   è¨­ç½®æˆæ¬Šè¦å‰‡å’Œè·¯ç”±ã€‚
    *   æ ¹æ“šç•¶å‰é¸æ“‡çš„ `staging.env` æˆ– `production.env` ä¸­çš„é…ç½®é€²è¡Œã€‚
2.  **æŸ¥çœ‹ç¾æœ‰ VPN ç«¯é»**: åˆ—å‡ºç•¶å‰ç’°å¢ƒé…ç½®çš„ VPN ç«¯é»åŠå…¶ç‹€æ…‹ã€‚
3.  **ç®¡ç† VPN ç«¯é»è¨­å®š**:
    *   ä¿®æ”¹æˆæ¬Šè¦å‰‡ (å…è¨±å“ªäº›ç¶²è·¯è¨ªå•)ã€‚
    *   ç®¡ç†è·¯ç”± (å°‡å“ªäº›æµé‡å°å…¥ VPN)ã€‚
    *   é—œè¯/å–æ¶ˆé—œè¯ç›®æ¨™ç¶²è·¯ã€‚
4.  **åˆªé™¤ VPN ç«¯é»**: å®‰å…¨åœ°åˆªé™¤ VPN ç«¯é»åŠç›¸é—œ AWS è³‡æº (å¦‚ ACM ä¸­çš„è­‰æ›¸ã€CloudWatch æ—¥èªŒçµ„)ã€‚**æ­¤æ“ä½œæ¥µå…·ç ´å£æ€§ï¼Œå‹™å¿…è¬¹æ…ã€‚**
5.  **æŸ¥çœ‹é€£æ¥æ—¥èªŒ**: æŒ‡å¼•å¦‚ä½•è¨ªå• CloudWatch ä¸­çš„ VPN é€£æ¥æ—¥èªŒã€‚
6.  **åŒ¯å‡ºåœ˜éšŠæˆå“¡è¨­å®šæª”**:
    *   ç‚ºæ–°æˆå“¡æº–å‚™åŸºç¤è¨­ç½®æ–‡ä»¶åŒ… (`team-configs/`)ã€‚
    *   åŒ…å« `team_member_setup.sh` è…³æœ¬å‰¯æœ¬ã€ç•¶å‰ç’°å¢ƒçš„ `ca.crt`ã€`team-setup-info.txt` (åŒ…å« VPN ç«¯é» ID ç­‰ä¿¡æ¯) å’ŒåŸºç¤çš„ `team-config-base.ovpn`ã€‚
7.  **ç³»çµ±å¥åº·æª¢æŸ¥**: æª¢æŸ¥ç•¶å‰ç’°å¢ƒ VPN ç«¯é»å’Œç›¸é—œé…ç½®çš„å¥åº·ç‹€æ…‹ã€‚
8.  **å¤š VPC ç®¡ç†**: (è‹¥æ”¯æŒ) é…ç½® VPN ç«¯é»èˆ‡å¤šå€‹ VPC çš„é—œè¯å’Œè·¯ç”±ã€‚

### 6.2 `revoke_member_access.sh` - æ¬Šé™æ’¤éŠ·å·¥å…·

ç”¨æ–¼æ’¤éŠ·ç‰¹å®šåœ˜éšŠæˆå“¡çš„ VPN è¨ªå•æ¬Šé™ã€‚

**å•Ÿå‹•æ–¹å¼:**
```bash
# ç¢ºä¿å·²åˆ‡æ›åˆ°ç›®æ¨™ç’°å¢ƒ
./admin-tools/revoke_member_access.sh
```

**æ’¤éŠ·æµç¨‹ (ç¤ºä¾‹):**
1.  **æª¢æŸ¥å·¥å…·å’Œæ¬Šé™**: ç¢ºä¿åŸ·è¡Œè€…æœ‰è¶³å¤ æ¬Šé™ã€‚
2.  **ç²å–æ’¤éŠ·è³‡è¨Š**: æç¤ºè¼¸å…¥è¦æ’¤éŠ·çš„ç”¨æˆ¶åå’Œç›®æ¨™ VPN ç«¯é» ID (é€šå¸¸å¾ç•¶å‰ç’°å¢ƒé…ç½®è®€å–)ã€‚
3.  **æœå°‹ç”¨æˆ¶è­‰æ›¸**: åœ¨ ACM ä¸­æ ¹æ“šç”¨æˆ¶åå’Œç›¸é—œæ¨™ç±¤æœç´¢ç”¨æˆ¶è­‰æ›¸ã€‚
4.  **æª¢æŸ¥ç•¶å‰é€£æ¥**: (å¯é¸) æª¢æŸ¥è©²ç”¨æˆ¶æ˜¯å¦æœ‰æ´»èºçš„ VPN é€£æ¥ã€‚
5.  **æ’¤éŠ·è­‰æ›¸å’Œæ¬Šé™**:
    *   å¾ AWS Client VPN ç«¯é»æ’¤éŠ·ç”¨æˆ¶è­‰æ›¸çš„æˆæ¬Šã€‚
    *   (å¯é¸) åˆªé™¤ ACM ä¸­çš„ç”¨æˆ¶è­‰æ›¸ã€‚
    *   (å¯é¸) çµ‚æ­¢è©²ç”¨æˆ¶çš„æ´»èº VPN é€£æ¥ã€‚
6.  **æª¢æŸ¥å’Œç§»é™¤ IAM æ¬Šé™**: (å¯é¸ï¼Œå¦‚æœç”¨æˆ¶æœ‰ç‰¹å®š IAM æ¬Šé™èˆ‡ VPN ç›¸é—œè¯)ã€‚
7.  **ç”Ÿæˆæ’¤éŠ·å ±å‘Š**: è¨˜éŒ„æ’¤éŠ·æ“ä½œçš„è©³ç´°ä¿¡æ¯åˆ°æ—¥èªŒæ–‡ä»¶ã€‚

### 6.3 `employee_offboarding.sh` - é›¢è·è™•ç†ç³»çµ±

æä¾›ä¸€å€‹æ¨™æº–åŒ–æµç¨‹ï¼Œç”¨æ–¼è™•ç†å“¡å·¥é›¢è·æ™‚çš„å…¨é¢è¨ªå•æ¬Šé™ç§»é™¤åŠç›¸é—œå®‰å…¨å¯©è¨ˆã€‚

**å•Ÿå‹•æ–¹å¼:**
```bash
# ç¢ºä¿å·²åˆ‡æ›åˆ°ç›®æ¨™ç’°å¢ƒ (é€šå¸¸æ‡‰åŒæ™‚æª¢æŸ¥ Staging å’Œ Production)
./admin-tools/employee_offboarding.sh
```

**é›¢è·è™•ç†æµç¨‹ (ç¤ºä¾‹):**
1.  **æ”¶é›†é›¢è·äººå“¡è³‡è¨Š**: è¼¸å…¥å“¡å·¥ç”¨æˆ¶åã€é›¢è·æ—¥æœŸç­‰ã€‚
2.  **é¢¨éšªè©•ä¼°**: (å¯é¸) æ ¹æ“šå“¡å·¥è§’è‰²è©•ä¼°é¢¨éšªç­‰ç´šã€‚
3.  **åŸ·è¡Œç·Šæ€¥å®‰å…¨æªæ–½**: (é«˜é¢¨éšªæƒ…æ³ä¸‹) å¯èƒ½åŒ…æ‹¬ç«‹å³ç¦ç”¨ç›¸é—œå¸³æˆ¶ã€‚
4.  **æ’¤éŠ· VPN è¨ªå•æ¬Šé™**:
    *   è‡ªå‹•èª¿ç”¨ `revoke_member_access.sh` çš„é‚è¼¯ï¼Œæˆ–åŸ·è¡Œé¡ä¼¼æ­¥é©Ÿã€‚
    *   ç¢ºä¿åœ¨ Staging å’Œ Production å…©å€‹ç’°å¢ƒéƒ½åŸ·è¡Œæ’¤éŠ·ã€‚
5.  **æ¸…ç† IAM æ¬Šé™**: æª¢æŸ¥ä¸¦ç§»é™¤è©²å“¡å·¥ä¸å†éœ€è¦çš„ IAM ç”¨æˆ¶/è§’è‰²æ¬Šé™ã€‚
6.  **å¯©è¨ˆè¨ªå•æ—¥èªŒ**: æª¢æŸ¥ VPN é€£æ¥æ—¥èªŒã€CloudTrail æ—¥èªŒç­‰ï¼Œå°‹æ‰¾ç•°å¸¸æ´»å‹•ã€‚
7.  **æª¢æŸ¥æ®˜ç•™è³‡æº**: æª¢æŸ¥æ˜¯å¦æœ‰è©²å“¡å·¥å‰µå»ºæˆ–æ“æœ‰çš„é›²è³‡æºéœ€è¦è™•ç†ã€‚
8.  **ç”Ÿæˆå®‰å…¨äº‹ä»¶å ±å‘Š**: è¨˜éŒ„æ•´å€‹é›¢è·è™•ç†éç¨‹å’Œç™¼ç¾ã€‚
9.  **ç”Ÿæˆé›¢è·æª¢æŸ¥æ¸…å–®**: ä¾› HR å’Œ IT ç¢ºèªæ‰€æœ‰æ­¥é©Ÿå·²å®Œæˆã€‚

---

## 7. æ—¥å¸¸æ“ä½œæŒ‡å—

(æ­¤éƒ¨åˆ†å…§å®¹åŸºæœ¬èˆ‡ `vpn_connection_manual.md` v2.0 ç‰ˆæœ¬ä¸€è‡´ï¼Œé€²è¡Œäº†çµæ§‹èª¿æ•´å’Œå¼·èª¿)

### 7.1 é›™ç’°å¢ƒæ—¥å¸¸å·¥ä½œæµç¨‹

#### å…¸å‹é–‹ç™¼æ—¥å·¥ä½œæµç¨‹
1.  **ä¸Šåˆï¼šé–‹ç™¼æ¸¬è©¦ï¼ˆStaging ç’°å¢ƒï¼‰**
    ```bash
    # (è‹¥æœ‰ vpn_env.sh) åˆ‡æ›åˆ° Staging ç’°å¢ƒ
    ./vpn_env.sh switch staging
    # (è‹¥æœ‰ vpn_env.sh) æª¢æŸ¥ç’°å¢ƒç‹€æ…‹
    ./vpn_env.sh status
    # åœ¨ AWS VPN Client ä¸­é¸æ“‡ "Staging VPN - [æ‚¨çš„å§“å]" ä¸¦é€£æ¥
    ```
2.  **ä¸‹åˆï¼šç”Ÿç”¢é™¤éŒ¯ï¼ˆProduction ç’°å¢ƒï¼‰**
    ```bash
    # æ–·é–‹ Staging VPN é€£æ¥
    # (è‹¥æœ‰ vpn_env.sh) åˆ‡æ›åˆ° Production ç’°å¢ƒ
    ./vpn_env.sh switch production # å®Œæˆé¡å¤–ç¢ºèªæµç¨‹
    # åœ¨ AWS VPN Client ä¸­é¸æ“‡ "Production VPN - [æ‚¨çš„å§“å]" ä¸¦é€£æ¥
    ```
3.  **å·¥ä½œçµæŸï¼šæ¸…ç†**
    - æ–·é–‹æ‰€æœ‰ VPN é€£æ¥ã€‚
    - (è‹¥æœ‰ vpn_env.sh) æª¢æŸ¥æœ€çµ‚ç‹€æ…‹: `./vpn_env.sh status`

### 7.2 ç’°å¢ƒåˆ‡æ›æ“ä½œè©³è§£

(æ­¤éƒ¨åˆ†å…§å®¹åŸºæœ¬èˆ‡ `vpn_connection_manual.md` v2.0 ç‰ˆæœ¬ä¸€è‡´ï¼Œæ•´åˆ `vpn_env.sh` å’Œ `enhanced_env_selector.sh` çš„ä½¿ç”¨)

**é—œéµæ­¥é©Ÿï¼š**
1.  **æ–·é–‹ç•¶å‰ VPN é€£æ¥**ã€‚
2.  **ä½¿ç”¨ `vpn_env.sh switch <target_env>` æˆ– `enhanced_env_selector.sh` åˆ‡æ›ç’°å¢ƒ**ã€‚
3.  **æ›´æ–° AWS VPN Client è¨­å®šæª”é¸æ“‡** (é¸æ“‡èˆ‡æ–°ç’°å¢ƒåŒ¹é…çš„ Profile)ã€‚
4.  **é‡æ–°é€£æ¥ä¸¦é©—è­‰**ã€‚

**å®‰å…¨ç¢ºèªï¼š**
- åˆ‡æ›åˆ° Production ç’°å¢ƒæ™‚ï¼Œæœƒæœ‰åš´æ ¼çš„ç¢ºèªæç¤ºã€‚

---

## 8. æª”æ¡ˆç³»çµ±å½±éŸ¿

æœ¬ç¯€æè¿°åŸ·è¡Œå„ä¸»è¦è…³æœ¬å¾Œï¼Œåœ¨æœ¬åœ°æ–‡ä»¶ç³»çµ±ä¸­å‰µå»ºæˆ–ä¿®æ”¹çš„æ–‡ä»¶å’Œç›®éŒ„ã€‚

### 8.1 `aws_vpn_admin.sh` çš„æª”æ¡ˆå½±éŸ¿

```bash
å°ˆæ¡ˆæ ¹ç›®éŒ„/
â”œâ”€â”€ configs/                        # ç®¡ç†å“¡ VPN é…ç½®
â”‚   â”œâ”€â”€ staging/staging.env        # Staging ç’°å¢ƒé…ç½® (å¯èƒ½ç”±æ­¤è…³æœ¬å‰µå»ºæˆ–å¡«å……)
â”‚   â””â”€â”€ production/production.env  # Production ç’°å¢ƒé…ç½® (åŒä¸Š)
â”œâ”€â”€ .vpn_config                      # âš ï¸ ä¸»é…ç½®æª”æ¡ˆ (æ•æ„Ÿ, è¨˜éŒ„ç•¶å‰ç’°å¢ƒç­‰)
â”œâ”€â”€ vpn_admin.log                    # ä¸»æ“ä½œæ—¥èªŒ (åˆ†ç’°å¢ƒè¨˜éŒ„ï¼Œä¾‹å¦‚ vpn_admin_staging.log)
â”œâ”€â”€ certificates/                   # ğŸ”’ è­‰æ›¸ç›®éŒ„ (é«˜åº¦æ•æ„Ÿ)
â”‚   â”œâ”€â”€ staging/                    # Staging ç’°å¢ƒè­‰æ›¸
â”‚   â”‚   â”œâ”€â”€ pki/                    # PKI çµæ§‹ (ca.crt, private/ca.key, issued/server.crt ç­‰)
â”‚   â”‚   â”œâ”€â”€ admin-config-base.ovpn # Staging ç®¡ç†å“¡åŸºç¤é…ç½®
â”‚   â”‚   â””â”€â”€ admin-config.ovpn      # Staging ç®¡ç†å“¡å®Œæ•´é…ç½® (å«ç§é‘°)
â”‚   â””â”€â”€ production/                 # Production ç’°å¢ƒè­‰æ›¸ (çµæ§‹åŒ Staging)
â”‚       â”œâ”€â”€ pki/
â”‚       â”œâ”€â”€ admin-config-base.ovpn
â”‚       â””â”€â”€ admin-config.ovpn
â””â”€â”€ team-configs/                   # åœ˜éšŠåˆ†ç™¼æª”æ¡ˆ (åˆ†ç’°å¢ƒ)
    â”œâ”€â”€ staging/
    â”‚   â”œâ”€â”€ team_member_setup.sh  # è…³æœ¬å‰¯æœ¬
    â”‚   â”œâ”€â”€ ca.crt                # Staging CA è­‰æ›¸å‰¯æœ¬
    â”‚   â”œâ”€â”€ team-setup-info.txt   # Staging è¨­ç½®è³‡è¨Š
    â”‚   â””â”€â”€ team-config-base.ovpn # Staging åœ˜éšŠåŸºç¤é…ç½®
    â””â”€â”€ production/ (çµæ§‹åŒ Staging)
        â”œâ”€â”€ team_member_setup.sh
        â”œâ”€â”€ ca.crt
        â”œâ”€â”€ team-setup-info.txt
        â””â”€â”€ team-config-base.ovpn
```

### 8.2 `team_member_setup.sh` çš„æª”æ¡ˆå½±éŸ¿ (ç”¨æˆ¶ç«¯)

```bash
ç”¨æˆ¶åŸ·è¡Œç›®éŒ„/
â”œâ”€â”€ .user_vpn_config               # âš ï¸ ç”¨æˆ¶é¸æ“‡çš„ç’°å¢ƒç­‰é…ç½® (æ•æ„Ÿ)
â”œâ”€â”€ user_vpn_setup.log             # ç”¨æˆ¶è¨­ç½®æ—¥èªŒ
â”œâ”€â”€ user-certificates/             # ğŸ”’ ç”¨æˆ¶è­‰æ›¸ç›®éŒ„ (é«˜åº¦æ•æ„Ÿ)
â”‚   â”œâ”€â”€ [username].crt             # ç”¨æˆ¶è­‰æ›¸
â”‚   â””â”€â”€ [username].key             # ğŸ” ç”¨æˆ¶ç§é‘° (æ¥µåº¦æ•æ„Ÿ)
â””â”€â”€ vpn-config/                    # VPN é…ç½®æª”æ¡ˆ
    â””â”€â”€ [username]-[environment]-config.ovpn # ğŸ”’ å€‹äºº VPN é…ç½® (å«ç§é‘°)
```

### 8.3 `revoke_member_access.sh` çš„æª”æ¡ˆå½±éŸ¿

```bash
å°ˆæ¡ˆæ ¹ç›®éŒ„/ (æˆ–æŒ‡å®šæ—¥èªŒç›®éŒ„)
â””â”€â”€ revocation-logs/               # æ’¤éŠ·æ—¥èªŒç›®éŒ„ (åˆ†ç’°å¢ƒ)
    â”œâ”€â”€ staging_revocation.log
    â”œâ”€â”€ production_revocation.log
    â””â”€â”€ [username]_revocation_[timestamp].log  # ğŸ“‹ å€‹åˆ¥æ’¤éŠ·å ±å‘Š
```

### 8.4 `employee_offboarding.sh` çš„æª”æ¡ˆå½±éŸ¿

```bash
å°ˆæ¡ˆæ ¹ç›®éŒ„/ (æˆ–æŒ‡å®šæ—¥èªŒç›®éŒ„)
â””â”€â”€ offboarding-logs/                           # é›¢è·è™•ç†æ—¥èªŒç›®éŒ„
    â”œâ”€â”€ offboarding_main.log                   # ä¸»è¦é›¢è·æ—¥èªŒ
    â”œâ”€â”€ security_report_[employee]_[timestamp].txt      # ğŸ“‹ å®‰å…¨å ±å‘Š
    â”œâ”€â”€ offboarding_checklist_[employee]_[timestamp].txt # ğŸ“‹ æª¢æŸ¥æ¸…å–®
    â””â”€â”€ audit-[employee_id]-[date]/            # å¯©è¨ˆè³‡æ–™ç›®éŒ„
        â”œâ”€â”€ audit_summary.txt                 # å¯©è¨ˆæ‘˜è¦
        â”œâ”€â”€ cloudtrail_events.json           # CloudTrail äº‹ä»¶è¨˜éŒ„
        â””â”€â”€ vpn_events_*.json                # VPN äº‹ä»¶æ—¥èªŒ
```

### 8.5 æª”æ¡ˆæ¬Šé™å’Œå®‰å…¨è¨­å®š

æ‰€æœ‰è…³æœ¬åœ¨å‰µå»ºæ•æ„Ÿæ–‡ä»¶ï¼ˆå¦‚ç§é‘° `.key`ï¼ŒåŒ…å«ç§é‘°çš„ `.ovpn` é…ç½®æ–‡ä»¶ï¼Œç’°å¢ƒé…ç½®æ–‡ä»¶ `.env`ï¼‰æ™‚ï¼Œæœƒè‡ªå‹•è¨­ç½®åš´æ ¼çš„æ–‡ä»¶æ¬Šé™ (é€šå¸¸æ˜¯ `chmod 600`ï¼Œåƒ…æ‰€æœ‰è€…å¯è®€å¯«)ã€‚
æ•æ„Ÿç›®éŒ„ï¼ˆå¦‚ `certificates/`, `user-certificates/`ï¼‰ä¹Ÿæœƒè¨­ç½®é©ç•¶æ¬Šé™ (é€šå¸¸æ˜¯ `chmod 700`)ã€‚

---

## 9. ç¶­è­·å’Œç›£æ§

### 9.1 å®šæœŸç¶­è­·ä»»å‹™

#### æ¯é€±æª¢æŸ¥æ¸…å–® (ç®¡ç†å“¡)
- [ ] æª¢æŸ¥ Staging å’Œ Production VPN ç«¯é»ç‹€æ…‹ (AWS Console, `aws_vpn_admin.sh`)ã€‚
- [ ] å¯©æŸ¥ VPN é€£æ¥æ—¥èªŒ (CloudWatch Logs)ï¼Œæ³¨æ„ç•°å¸¸ç™»éŒ„å˜—è©¦æˆ–é€£æ¥æ¨¡å¼ã€‚
- [ ] æª¢æŸ¥ `vpn_env.sh health` çš„è¼¸å‡ºï¼Œé—œæ³¨è­¦å‘Šã€‚

#### æ¯æœˆæª¢æŸ¥æ¸…å–® (ç®¡ç†å“¡)
- [ ] æ›´æ–°åœ˜éšŠæˆå“¡æ¸…å–®ï¼Œæ’¤éŠ·ä¸å†éœ€è¦çš„è¨ªå•æ¬Šé™ (`revoke_member_access.sh`)ã€‚
- [ ] å¯©æŸ¥ IAM æ¬Šé™ï¼Œç¢ºä¿æœ€å°æ¬Šé™åŸå‰‡ã€‚
- [ ] æª¢æŸ¥å¤š VPC ç¶²è·¯é…ç½® (å¦‚æœé©ç”¨)ã€‚
- [ ] å‚™ä»½ Staging å’Œ Production ç’°å¢ƒçš„é…ç½® (`configs/`) å’Œè­‰æ›¸ (`certificates/`) æ–‡ä»¶ (åŠ å¯†å­˜å„²)ã€‚

#### æ¯å­£æª¢æŸ¥æ¸…å–® (ç®¡ç†å“¡)
- [ ] åŸ·è¡Œä¸€æ¬¡å…¨é¢çš„å®‰å…¨å¯©è¨ˆ (IAM ç­–ç•¥, å®‰å…¨çµ„, NACL, VPN é…ç½®)ã€‚
- [ ] è€ƒæ…®æ›´æ–° AWS æ¬Šé™æ”¿ç­–ã€‚
- [ ] è¦åŠƒè­‰æ›¸è¼ªæ› (å°¤å…¶æ˜¯å®¢æˆ¶ç«¯è­‰æ›¸ï¼Œåƒè¦‹[è­‰æ›¸å®‰å…¨ç®¡ç†](#è­‰æ›¸å®‰å…¨ç®¡ç†))ã€‚
- [ ] æ¸¬è©¦ç½é›£æ¢å¾©æµç¨‹ (ä¾‹å¦‚ï¼Œå¾å‚™ä»½æ¢å¾© VPN ç«¯é»é…ç½®)ã€‚

### 9.2 è‡ªå‹•åŒ–ç›£æ§ç¯„ä¾‹

ç®¡ç†å“¡å¯ä»¥è¨­ç½® CloudWatch Alarms ä¾†ç›£æ§ VPN çš„é—œéµæŒ‡æ¨™ã€‚
æ­¤å¤–ï¼Œå¯ä»¥ç·¨å¯«ç°¡å–®çš„æœ¬åœ°è…³æœ¬é€²è¡Œå®šæœŸå¥åº·æª¢æŸ¥ï¼Œä¸¦é€šé cron job é‹è¡Œã€‚

```bash
#!/bin/bash
# health_check_cron.sh - ç°¡æ˜“ VPN å¥åº·æª¢æŸ¥è…³æœ¬ç¯„ä¾‹
# æ³¨æ„: ç›´æ¥åœ¨ cron ä¸­é‹è¡Œéœ€è¦è™•ç†éäº’å‹•å¼ç¢ºèªï¼Œ
# ä¾‹å¦‚ Production ç’°å¢ƒåˆ‡æ›ã€‚æ­¤è™•çš„ --auto-confirm æ˜¯å‡è¨­æ€§åƒæ•¸ã€‚
# å¯¦éš›éƒ¨ç½²å¯èƒ½éœ€è¦ expect è…³æœ¬æˆ–ä¿®æ”¹ vpn_env.sh ä»¥æ”¯æŒéäº’å‹•æ¨¡å¼ã€‚
LOG_FILE=~/vpn_health_cron.log
VPN_TOOLS_DIR=~/aws-vpn-tools # ä¿®æ”¹ç‚ºæ‚¨çš„å·¥å…·ç›®éŒ„

echo "=== Cron Health Check Started: $(date) ===" >> $LOG_FILE

cd $VPN_TOOLS_DIR

# æª¢æŸ¥ Staging ç’°å¢ƒ
echo "--- Checking Staging ---" >> $LOG_FILE
./vpn_env.sh switch staging >> $LOG_FILE 2>&1
./vpn_env.sh health >> $LOG_FILE 2>&1
# å¯é¸ï¼šæª¢æŸ¥ Staging ç«¯é»æ´»èºé€£æ¥æ•¸
# aws ec2 describe-client-vpn-connections --client-vpn-endpoint-id $(grep VPN_ENDPOINT_ID configs/staging/staging.env | cut -d'=' -f2) --query "Connections[?Status.Code=='active'] | length(@)" --output text >> $LOG_FILE

# æª¢æŸ¥ Production ç’°å¢ƒ
echo "--- Checking Production ---" >> $LOG_FILE
./vpn_env.sh switch production --auto-confirm # å‡è¨­è…³æœ¬æœ‰æ­¤é¡éäº’å‹•é¸é …ï¼Œå¦å‰‡ cron æœƒå¡ä½
./vpn_env.sh health >> $LOG_FILE 2>&1
# å¯é¸ï¼šæª¢æŸ¥ Production ç«¯é»æ´»èºé€£æ¥æ•¸

echo "=== Cron Health Check Ended: $(date) ===" >> $LOG_FILE
echo "" >> $LOG_FILE

# å¦‚æœæª¢æ¸¬åˆ° "è­¦å‘Š" æˆ– "éŒ¯èª¤"ï¼Œå¯ä»¥ç™¼é€éƒµä»¶é€šçŸ¥
# if grep -q "è­¦å‘Š\|éŒ¯èª¤" $LOG_FILE; then
#    mail -s "VPN Health Alert" admin@example.com < $LOG_FILE
# fi
```
**æ³¨æ„**: ä¸Šè¿°è…³æœ¬åƒ…ç‚ºç¯„ä¾‹ï¼Œå¯¦éš›ç”¨æ–¼ cron æ™‚éœ€è™•ç†å¥½éäº’å‹•åŸ·è¡Œå’ŒéŒ¯èª¤æ•æ‰ã€‚

---

## 10. å®‰å…¨æœ€ä½³å¯¦è¸

(æ•´åˆ `readme.md` çš„è©³ç´°å…§å®¹å’Œ `vpn_connection_manual.md` v2.0 çš„åŸå‰‡)

### 10.1 é›™ç’°å¢ƒå®‰å…¨åŸå‰‡
- **ç’°å¢ƒéš”é›¢**: Staging å’Œ Production æ•¸æ“šã€æ†‘è­‰ã€é…ç½®åš´æ ¼åˆ†é›¢ã€‚
- **Production ç’°å¢ƒä¿è­·**: å¢å¼·ç¢ºèªï¼Œé™åˆ¶è¨ªå•ï¼Œè©³ç´°æ—¥èªŒã€‚
- **ç’°å¢ƒåˆ‡æ›å®‰å…¨**: é©—è­‰ç•¶å‰ç’°å¢ƒï¼Œå®‰å…¨åˆ‡æ›ï¼Œé©—è­‰åˆ‡æ›çµæœã€‚

### 10.2 è­‰æ›¸å®‰å…¨ç®¡ç†
1.  **è­‰æ›¸è¼ªæ›ç­–ç•¥**:
    *   CA è­‰æ›¸: æ¯ 2-5 å¹´ (æ ¹æ“šçµ„ç¹”ç­–ç•¥)ã€‚
    *   ä¼ºæœå™¨è­‰æ›¸: æ¯å¹´ã€‚
    *   å®¢æˆ¶ç«¯è­‰æ›¸: æ¯ 6-12 å€‹æœˆ (æˆ–å“¡å·¥é›¢è·/è¨­å‚™ä¸Ÿå¤±æ™‚ç«‹å³æ’¤éŠ·)ã€‚
    *   ä½¿ç”¨ `aws_vpn_admin.sh` ä¸­çš„åŠŸèƒ½ï¼ˆå¦‚æœæ”¯æŒï¼‰æˆ–æ‰‹å‹•æµç¨‹é…åˆ Easy-RSA é€²è¡Œè¼ªæ›ã€‚
2.  **ç§é‘°ä¿è­·**:
    *   æ‰€æœ‰ `.key` æ–‡ä»¶è‡ªå‹•è¨­ç‚º `600` æ¬Šé™ã€‚
    *   CA ç§é‘° (`certificates/[environment]/pki/private/ca.key`) æ˜¯æœ€é‡è¦çš„è³‡ç”¢ï¼Œæ‡‰é›¢ç·šå‚™ä»½åˆ°åŠ å¯†å­˜å„²ï¼Œä¸¦åš´æ ¼æ§åˆ¶è¨ªå•ã€‚
    *   è€ƒæ…®ä½¿ç”¨ç¡¬é«”å®‰å…¨æ¨¡çµ„ (HSM) ç®¡ç† CA ç§é‘° (é«˜ç´šé¸é …)ã€‚
3.  **è­‰æ›¸å‚™ä»½ (ç®¡ç†å“¡)**:
    ```bash
    # å‰µå»ºç‰¹å®šç’°å¢ƒçš„åŠ å¯†å‚™ä»½ (ç¤ºä¾‹)
    ENV_NAME="staging" # æˆ– "production"
    BACKUP_FILE="vpn-certs-${ENV_NAME}-$(date +%Y%m%d).tar.gz"
    tar -czf "${BACKUP_FILE}" "certificates/${ENV_NAME}/" "configs/${ENV_NAME}/"
    gpg --symmetric --cipher-algo AES256 "${BACKUP_FILE}"
    # å®‰å…¨åˆªé™¤åŸå§‹ tar æ–‡ä»¶
    # rm "${BACKUP_FILE}"
    # å°‡ .gpg æ–‡ä»¶å­˜å„²åˆ°å®‰å…¨çš„å¤šå€‹é›¢ç·šä½ç½®
    ```

### 10.3 è¨ªå•æ§åˆ¶
1.  **æœ€å°æ¬Šé™åŸå‰‡**:
    *   ç‚ºç®¡ç†å“¡å’Œç”¨æˆ¶åˆ†é…åƒ…åŸ·è¡Œå…¶ä»»å‹™æ‰€å¿…éœ€çš„æœ€å° IAM æ¬Šé™ (åƒè¦‹[é™„éŒ„ IAM æ”¿ç­–](#iam-æ¬Šé™æ”¿ç­–ç¯„ä¾‹))ã€‚
    *   å®šæœŸå¯©æŸ¥ AWS æ¬Šé™ã€‚
    *   æ¨è–¦ç‚º AWS Client VPN å•Ÿç”¨å¤šå› ç´ èªè­‰ (MFA)ã€‚
2.  **ç¶²è·¯åˆ†æ®µ**:
    *   åˆç†è¦åŠƒ VPN å®¢æˆ¶ç«¯åœ°å€æ±  (CIDR) å’Œ VPC å…§éƒ¨ç¶²è·¯çš„ CIDRï¼Œé¿å…é‡ç–Šã€‚
    *   å»ºè­°çš„ CIDR åˆ†é… (ç¤ºä¾‹):
        *   VPN å®¢æˆ¶ç«¯ (Staging): `172.16.0.0/22`
        *   VPN å®¢æˆ¶ç«¯ (Production): `172.20.0.0/22`
        *   å…§éƒ¨ Staging VPC: `10.10.0.0/16`
        *   å…§éƒ¨ Production VPC: `10.20.0.0/16`
    *   ä½¿ç”¨å®‰å…¨çµ„å’Œ NACLåš´æ ¼æ§åˆ¶å¾ VPN åˆ° VPC å…§éƒ¨è³‡æºçš„è¨ªå•ã€‚
3.  **ç›£æ§å’Œå¯©è¨ˆ**:
    *   å•Ÿç”¨ CloudTrail è©³ç´°è¨˜éŒ„æ‰€æœ‰ AWS API èª¿ç”¨ã€‚
    *   è¨­ç½® CloudWatch Logs ä¿å­˜ VPN é€£æ¥æ—¥èªŒï¼Œä¸¦å¯è¨­ç½®è­¦å ±ã€‚
    *   å®šæœŸæª¢æŸ¥é€£æ¥æ—¥èªŒå’Œå¯©è¨ˆæ—¥èªŒã€‚

### 10.4 é…ç½®æ–‡ä»¶å®‰å…¨
- æª¢æŸ¥æ•æ„Ÿæ–‡ä»¶æ¬Šé™ (å¦‚ `.ovpn`, `.key`, `.env` æ–‡ä»¶æ‡‰ç‚º `600`)ã€‚
- å®šæœŸåŸ·è¡Œæ¬Šé™æª¢æŸ¥è…³æœ¬ (ç®¡ç†å“¡):
  ```bash
  #!/bin/bash
  echo "=== æ•æ„Ÿæ–‡ä»¶æ¬Šé™æª¢æŸ¥ ==="
  find . -type f \( -name "*.key" -o -name "*.ovpn" -o -name "*.env" -o -name ".vpn_config" -o -name ".user_vpn_config" \) -print0 | \
  while IFS= read -r -d $'\0' file; do
      perms=$(stat -f "%Lp" "$file" 2>/dev/null || stat -c "%a" "$file")
      expected_perms="600"
      # æŸäº›ç›®éŒ„ä¸‹çš„ ovpn å¯èƒ½æ˜¯ 644ï¼Œä½†å«ç§é‘°çš„æ‡‰ç‚º 600
      # æ­¤è™•ç°¡åŒ–ç‚ºå…¨éƒ¨æª¢æŸ¥ 600ï¼Œå¯æ ¹æ“šå¯¦éš›æƒ…æ³èª¿æ•´
      if [ "$perms" = "$expected_perms" ]; then
          echo "âœ“ $file ($perms)"
      else
          echo "âœ— $file ($perms, æ‡‰ç‚º $expected_perms)"
      fi
  done
  ```

### 10.5 VPN ä½¿ç”¨å®‰å…¨ (ç”¨æˆ¶)
- åƒ…åœ¨éœ€è¦æ™‚é€£æ¥ VPNã€‚
- å®Œæˆå·¥ä½œå¾Œç«‹å³æ–·é–‹ã€‚
- ä¸åœ¨å…¬å…± Wi-Fi ä¸Šè™•ç†é«˜åº¦æ•æ„Ÿæ•¸æ“š (å³ä½¿é€šé VPN)ã€‚
- åš´ç¦åˆ†äº«å€‹äºº VPN é…ç½®æ–‡ä»¶æˆ–æ†‘è­‰ã€‚

### 10.6 äº‹ä»¶éŸ¿æ‡‰
- **ç”¨æˆ¶**: è‹¥æ‡·ç–‘é…ç½®æ–‡ä»¶æ´©éœ²æˆ–é›»è…¦æ„ŸæŸ“ï¼Œç«‹å³é€šçŸ¥ IT ç®¡ç†å“¡ã€‚
- **ç®¡ç†å“¡**:
    - æº–å‚™å¥½æ‡‰æ€¥ç¨‹åº (åƒè¦‹[ç·Šæ€¥è¯çµ¡ç¯„æœ¬](#ç·Šæ€¥è¯çµ¡ç¯„æœ¬))ã€‚
    - ç™¼ç”Ÿå®‰å…¨äº‹ä»¶æ™‚ï¼Œç«‹å³ä½¿ç”¨ `revoke_member_access.sh` æ’¤éŠ·ç›¸é—œäººå“¡æ¬Šé™ã€‚
    - åˆ†ææ—¥èªŒï¼Œç¢ºå®šå½±éŸ¿ç¯„åœã€‚
    - æ ¹æ“šæƒ…æ³åŸ·è¡Œ `employee_offboarding.sh` ä¸­çš„éƒ¨åˆ†æµç¨‹ã€‚

---

## 11. æ•…éšœæ’é™¤

(æ•´åˆ `readme.md` çš„è©³ç´°å…§å®¹å’Œ `vpn_connection_manual.md` v2.0 çš„å…§å®¹)

### 11.1 é›™ç’°å¢ƒç›¸é—œå•é¡Œ
(åƒè€ƒ `vpn_connection_manual.md` v2.0 å·²æœ‰çš„ "é›™ç’°å¢ƒç›¸é—œå•é¡Œ" ä¸¦æ“´å……)
- **ç’°å¢ƒåˆ‡æ›å¤±æ•—**: æª¢æŸ¥ `vpn_env.sh` åŠ `lib/env_manager.sh` æ˜¯å¦å­˜åœ¨ä¸”æœ‰åŸ·è¡Œæ¬Šé™ï¼Œ`configs/[env]/[env].env` æ–‡ä»¶æ˜¯å¦æ­£ç¢ºã€‚å˜—è©¦ `vpn_env.sh init`ã€‚
- **ç’°å¢ƒèˆ‡è¨­å®šæª”ä¸åŒ¹é…**: åŸ·è¡Œ `./vpn_env.sh status` ç¢ºèªç•¶å‰ shell ç’°å¢ƒï¼Œå°æ¯” AWS VPN Client ä¸­é¸æ“‡çš„ Profile åç¨±ã€‚
- **Production ç’°å¢ƒç¢ºèªå¤±æ•—**: ç¢ºèªç¢¼ç‚ºå¤§å¯« `PROD`ï¼Œç”¨æˆ¶åéœ€åŒ¹é…ã€‚

### 11.2 ç®¡ç†å·¥å…·å¸¸è¦‹å•é¡Œ
- **æ¨¡çµ„è¼‰å…¥éŒ¯èª¤ (`core_functions.sh not found`)**:
    - **åŸå› **: `lib` ç›®éŒ„æˆ–æ ¸å¿ƒå‡½å¼åº«æ–‡ä»¶ç¼ºå¤±æˆ–è·¯å¾‘ä¸å°ã€‚
    - **è§£æ±º**: ç¢ºä¿åŸ·è¡Œè…³æœ¬æ™‚ä½æ–¼å°ˆæ¡ˆæ ¹ç›®éŒ„ï¼Œ`lib` ç›®éŒ„åŠå…§éƒ¨ `.sh` æ–‡ä»¶å­˜åœ¨ä¸”æœ‰è®€å–æ¬Šé™ã€‚
- **AWS æ¬Šé™éŒ¯èª¤ (`AccessDenied`)**:
    - **åŸå› **: åŸ·è¡Œè…³æœ¬çš„ IAM ç”¨æˆ¶/è§’è‰²æ¬Šé™ä¸è¶³ã€‚
    - **è§£æ±º**: ä½¿ç”¨ `aws sts get-caller-identity` æª¢æŸ¥ç•¶å‰èº«ä»½ã€‚å°ç…§[é™„éŒ„ IAM æ”¿ç­–](#iam-æ¬Šé™æ”¿ç­–ç¯„ä¾‹)æª¢æŸ¥ä¸¦è£œé½Šæ‰€éœ€æ¬Šé™ã€‚ç¢ºèª AWS CLI é…ç½®çš„å€åŸŸæ­£ç¢ºã€‚
- **è­‰æ›¸ç”Ÿæˆå¤±æ•— (PKI åˆå§‹åŒ–å¤±æ•— / Easy-RSA éŒ¯èª¤)**:
    - **åŸå› **: `certificates/[environment]/pki` ç›®éŒ„æ¬Šé™å•é¡Œï¼Œæˆ– Easy-RSA å·¥å…·å•é¡Œã€‚
    - **è§£æ±º**: ç¢ºä¿ `certificates` ç›®éŒ„å¯å¯«ã€‚å¯å˜—è©¦åˆªé™¤ (å‚™ä»½å¾Œ) `certificates/[environment]/pki` ä¸¦è®“ `aws_vpn_admin.sh` é‡æ–°åˆå§‹åŒ– (å¦‚æœå®ƒè² è²¬åˆå§‹åŒ–)ã€‚ç¢ºä¿ Easy-RSA å·²æ­£ç¢ºå®‰è£ä¸¦åœ¨ PATH ä¸­ã€‚
- **é…ç½®æ–‡ä»¶ `.vpn_config` æˆ– `[env].env` æå£/ç¼ºå¤±**:
    - **åŸå› **: æ–‡ä»¶è¢«æ„å¤–ä¿®æ”¹æˆ–åˆªé™¤ã€‚
    - **è§£æ±º**: å¦‚æœæ˜¯ `.vpn_config` (è¨˜éŒ„ç•¶å‰ç’°å¢ƒç­‰)ï¼Œå¯ç”± `vpn_env.sh switch` è‡ªå‹•é‡å»ºã€‚å¦‚æœæ˜¯ `configs/[env]/[env].env`ï¼Œéœ€å¾å‚™ä»½æ¢å¾©æˆ–æ ¹æ“šæ¨¡æ¿æ‰‹å‹•é‡å»ºé—œéµåƒæ•¸ã€‚

### 11.3 ç”¨æˆ¶ç«¯é€£æ¥å¸¸è¦‹å•é¡Œ
(åƒè€ƒ `vpn_connection_manual.md` v2.0 å·²æœ‰çš„ "å‚³çµ± VPN å•é¡Œï¼ˆæ›´æ–°ç‰ˆï¼‰" åŠ "ä¸€èˆ¬ VPN é€£æ¥å•é¡Œ")
- **ç„¡æ³•å°å…¥ç’°å¢ƒå°ˆç”¨é…ç½®æª”æ¡ˆ**: æª¢æŸ¥ `.ovpn` æ–‡ä»¶æ˜¯å¦å®Œæ•´ï¼Œæ˜¯å¦é¸å°äº† Staging/Production å°æ‡‰çš„é…ç½®æ–‡ä»¶ã€‚
- **ç’°å¢ƒç‰¹å®šèªè­‰éŒ¯èª¤**: æª¢æŸ¥ç”¨æˆ¶è­‰æ›¸ (`.crt`) å’Œç§é‘° (`.key`) æ˜¯å¦åŒ¹é…ï¼Œè­‰æ›¸æ˜¯å¦éæœŸã€‚
- **DNS è§£æå•é¡Œ (ç’°å¢ƒæ„ŸçŸ¥ç‰ˆ)**: `scutil --dns` æŸ¥çœ‹ç•¶å‰ DNSï¼Œ`nslookup` æ¸¬è©¦ã€‚

### 11.4 æ—¥èªŒæ–‡ä»¶åˆ†æ
- **ç®¡ç†å“¡æ—¥èªŒ**:
    - `vpn_admin_[environment].log` (ç”± `aws_vpn_admin.sh` ç­‰å·¥å…·ç”Ÿæˆ)
    - `revocation-logs/[environment]_revocation.log`
    - `offboarding-logs/offboarding_main.log`
- **ç”¨æˆ¶ç«¯æ—¥èªŒ**:
    - `user_vpn_setup.log` (ç”± `team_member_setup.sh` ç”Ÿæˆ)
- **ç³»çµ±æ—¥èªŒ (macOS)**:
    - `Console.app` ä¸­æœç´¢ "AWS VPN Client" æˆ– "NEKit"ã€‚
    - å‘½ä»¤è¡Œ: `log stream --level debug --predicate 'subsystem contains "com.apple.networkextension" or processImagePath contains "AWS VPN Client"'` (å¯èƒ½éœ€è¦èª¿æ•´è¬‚è©)
- **CloudWatch Logs**: AWS Client VPN ç«¯é»é€£æ¥æ—¥èªŒã€‚

---

## 12. AWS è³‡æºå’Œæˆæœ¬ç®¡ç†

### 12.1 å‰µå»ºçš„ AWS è³‡æº

åŸ·è¡Œæœ¬å·¥å…·å¥—ä»¶ï¼ˆä¸»è¦æ˜¯ `aws_vpn_admin.sh`ï¼‰æœƒåœ¨ AWS ä¸­å‰µå»ºå’Œç®¡ç†ä»¥ä¸‹è³‡æºï¼š

#### æ ¸å¿ƒè³‡æº (æ¯å€‹ç’°å¢ƒç¨ç«‹)
-   **AWS Client VPN Endpoint**:
    *   ä¾‹å¦‚ `cvpn-endpoint-xxxxxxxxxxxxxxxxx`
    *   æˆæœ¬: æŒ‰å°æ™‚æ”¶è²»çš„ç«¯é»é—œè¯è²» + æ¯å®¢æˆ¶ç«¯é€£æ¥æŒ‰å°æ™‚æ”¶è²»ã€‚
-   **AWS Certificate Manager (ACM) è­‰æ›¸**:
    *   ä¼ºæœå™¨è­‰æ›¸ (ä¾‹å¦‚ `server-[environment]-cert`)ã€‚
    *   å®¢æˆ¶ç«¯ CA è­‰æ›¸ (ä¾‹å¦‚ `client-ca-[environment]-cert`)ã€‚
    *   (å¦‚æœ `team_member_setup.sh` ä¸Šå‚³ç”¨æˆ¶è­‰æ›¸) å€‹åˆ¥ç”¨æˆ¶è­‰æ›¸ã€‚
    *   ACM æä¾›çš„è­‰æ›¸æœ¬èº«å…è²»ï¼Œä½†é€šé Client VPN ä½¿ç”¨å®ƒå€‘ç”¢ç”Ÿä¸Šè¿°ç«¯é»è²»ç”¨ã€‚
-   **CloudWatch Log Group**:
    *   ä¾‹å¦‚ `/aws/clientvpn/[VPN_Endpoint_Name]`ã€‚
    *   æˆæœ¬: æ—¥èªŒå­˜å„²è²»ç”¨ + æ—¥èªŒæ”å…¥è²»ç”¨ã€‚

#### ç¶²è·¯è³‡æº (æ¯å€‹ç’°å¢ƒç¨ç«‹)
-   **ç›®æ¨™ç¶²è·¯é—œè¯**: VPN ç«¯é»èˆ‡ VPC å­ç¶²è·¯çš„é—œè¯ã€‚
-   **æˆæ¬Šè¦å‰‡**: å®šç¾©å“ªäº›å®¢æˆ¶ç«¯ CIDR å¯ä»¥è¨ªå•å“ªäº›ç›®æ¨™ç¶²è·¯ã€‚
-   **è·¯ç”±è¦å‰‡**: å®šç¾©æµé‡å¦‚ä½•é€šé VPN è·¯ç”±ã€‚

### 12.2 æˆæœ¬å„ªåŒ–å»ºè­°

1.  **æŒ‰éœ€ä½¿ç”¨**:
    *   åƒ…åœ¨éœ€è¦æ™‚ä¿æŒ VPN ç«¯é»çš„ç¶²è·¯é—œè¯ã€‚è‹¥æŸç’°å¢ƒé•·æœŸä¸ç”¨ï¼Œå¯è€ƒæ…®å–æ¶ˆé—œè¯æˆ–åˆªé™¤ç«¯é» (æ³¨æ„æ•¸æ“šå‚™ä»½)ã€‚
    *   æ•™è‚²ç”¨æˆ¶åœ¨ä½¿ç”¨å®Œç•¢å¾Œç«‹å³æ–·é–‹ VPN é€£æ¥ï¼Œä»¥æ¸›å°‘å®¢æˆ¶ç«¯é€£æ¥å°æ™‚æ•¸ã€‚
2.  **ç›£æ§æ´»èºé€£æ¥**:
    ```bash
    # é‡å°ç‰¹å®šç’°å¢ƒçš„ç«¯é» ID
    aws ec2 describe-client-vpn-connections \
        --client-vpn-endpoint-id cvpn-endpoint-xxxxxxxxxxxxxxxxx \
        --query 'Connections[?Status.Code==`active`]' \
        --output table
    ```
3.  **æ—¥èªŒä¿ç•™ç­–ç•¥**:
    *   ç‚º CloudWatch Log Group è¨­ç½®åˆç†çš„æ—¥èªŒä¿ç•™æœŸé™ (ä¾‹å¦‚ 30-90 å¤©)ï¼Œé¿å…ç„¡é™æœŸå­˜å„²ç”¢ç”Ÿéé«˜è²»ç”¨ã€‚
    ```bash
    aws logs put-retention-policy \
        --log-group-name "/aws/clientvpn/[VPN_Endpoint_Name]" \
        --retention-in-days 30 # è‡ªå®šç¾©å¤©æ•¸
    ```
4.  **é¸æ“‡åˆé©å€åŸŸ**: ä¸åŒ AWS å€åŸŸçš„å®šåƒ¹å¯èƒ½æœ‰ç´°å¾®å·®åˆ¥ã€‚
5.  **åˆ†å‰²é€šé“ (Split-Tunneling)**:
    *   å•Ÿç”¨åˆ†å‰²é€šé“å¯ä»¥è®“éç›®æ¨™ç¶²è·¯çš„æµé‡ (ä¾‹å¦‚è¨ªå•å…¬é–‹ç¶²ç«™) ä¸ç¶“é VPNï¼Œæ¸›å°‘ VPN è² è¼‰å’Œæ½›åœ¨çš„æ•¸æ“šå‚³è¼¸æˆæœ¬ã€‚è…³æœ¬é»˜èªæ‡‰å•Ÿç”¨æ­¤åŠŸèƒ½ã€‚

---

## 13. å®Œæ•´ç§»é™¤æŒ‡å— (ç®¡ç†å“¡)

æœ¬æŒ‡å—æè¿°å¦‚ä½•å¾¹åº•ç§»é™¤ç”±æœ¬å·¥å…·å¥—ä»¶å‰µå»ºçš„ AWS è³‡æºå’Œæœ¬åœ°æ–‡ä»¶ã€‚**æ“ä½œå…·æœ‰ç ´å£æ€§ï¼Œè«‹è¬¹æ…åŸ·è¡Œä¸¦æå‰å‚™ä»½é‡è¦æ•¸æ“šã€‚**

### 13.1 åœæ­¢æ‰€æœ‰æœå‹™

1.  **é€šçŸ¥ç”¨æˆ¶**: æå‰é€šçŸ¥æ‰€æœ‰ç”¨æˆ¶å°‡è¦åœç”¨ VPN æœå‹™ã€‚
2.  **æ–·é–‹æ‰€æœ‰ VPN é€£æ¥**:
    *   æŒ‡å°ç”¨æˆ¶æ‰‹å‹•æ–·é–‹ã€‚
    *   ç®¡ç†å“¡å¯å¾ AWS Console æˆ–ä½¿ç”¨ AWS CLI å¼·åˆ¶çµ‚æ­¢æ´»èºé€£æ¥ï¼š
    ```bash
    # é‡å° Staging ç’°å¢ƒ (ç¤ºä¾‹ï¼Œæ›¿æ›ç‚ºå¯¦éš›ç«¯é»ID)
    STAGING_ENDPOINT_ID=$(grep VPN_ENDPOINT_ID configs/staging/staging.env | cut -d'=' -f2)
    aws ec2 describe-client-vpn-connections --client-vpn-endpoint-id $STAGING_ENDPOINT_ID --query "Connections[*].ConnectionId" --output text | \
    xargs -I {} aws ec2 terminate-client-vpn-connections --client-vpn-endpoint-id $STAGING_ENDPOINT_ID --connection-id {}

    # é‡å° Production ç’°å¢ƒ (ç¤ºä¾‹)
    PROD_ENDPOINT_ID=$(grep VPN_ENDPOINT_ID configs/production/production.env | cut -d'=' -f2)
    # ... é‡å¾©ä¸Šè¿°å‘½ä»¤
    ```

### 13.2 ä½¿ç”¨å·¥å…·æ¸…ç† AWS è³‡æº

æ¨è–¦ä½¿ç”¨ `aws_vpn_admin.sh` è…³æœ¬ï¼ˆå¦‚æœå…¶ "åˆªé™¤ VPN ç«¯é»" åŠŸèƒ½å®Œå–„ï¼‰ä¾†æ¸…ç†å°æ‡‰ç’°å¢ƒçš„ AWS è³‡æºï¼Œå› ç‚ºå®ƒäº†è§£æ‰€å‰µå»ºè³‡æºçš„é—œè¯æ€§ã€‚

```bash
# æ¸…ç† Staging ç’°å¢ƒ
./vpn_env.sh switch staging
./admin-tools/aws_vpn_admin.sh
# é¸æ“‡é¸é … 4: åˆªé™¤ VPN ç«¯é» (ä»”ç´°ç¢ºèªæç¤º)

# æ¸…ç† Production ç’°å¢ƒ
./vpn_env.sh switch production
./admin-tools/aws_vpn_admin.sh
# é¸æ“‡é¸é … 4: åˆªé™¤ VPN ç«¯é» (ä»”ç´°ç¢ºèªæç¤º)
```

**å¦‚æœæ‰‹å‹•æ¸…ç†ï¼Œä¸»è¦æ­¥é©ŸåŒ…æ‹¬ (æ¯å€‹ç’°å¢ƒéƒ½è¦åš):**
1.  **åˆªé™¤ Client VPN Endpoint**:
    ```bash
    aws ec2 delete-client-vpn-endpoint --client-vpn-endpoint-id cvpn-endpoint-xxxxxxxxxxxxxxxxx
    ```
2.  **åˆªé™¤ ACM ä¸­çš„è­‰æ›¸**:
    *   ä¼ºæœå™¨è­‰æ›¸ ARN (å¾ `[env].env` æ–‡ä»¶ç²å– `SERVER_CERT_ARN`)
    *   å®¢æˆ¶ç«¯ CA è­‰æ›¸ ARN (å¾ `[env].env` æ–‡ä»¶ç²å– `CLIENT_CERT_ARN`)
    *   (å¦‚æœé©ç”¨) ç”¨æˆ¶è­‰æ›¸
    ```bash
    aws acm delete-certificate --certificate-arn arn:aws:acm:region:account:certificate/xxxxxx
    ```
3.  **åˆªé™¤ CloudWatch Log Group**:
    ```bash
    aws logs delete-log-group --log-group-name "/aws/clientvpn/[VPN_Endpoint_Name]"
    ```
4.  **æª¢æŸ¥ä¸¦æ¸…ç†ç›¸é—œ IAM è§’è‰²/æ”¿ç­–** (å¦‚æœå‰µå»ºäº†å°ˆç”¨è§’è‰²)ã€‚
5.  **æª¢æŸ¥ä¸¦æ¸…ç†ç›¸é—œå®‰å…¨çµ„** (å¦‚æœå‰µå»ºäº†å°ˆç”¨å®‰å…¨çµ„)ã€‚

### 13.3 æ¸…ç†æœ¬åœ°æ–‡ä»¶

```bash
# å‚™ä»½é‡è¦æ–‡ä»¶å¾ŒåŸ·è¡Œï¼
# åˆªé™¤é…ç½®æ–‡ä»¶ç›®éŒ„
rm -rf configs/
# åˆªé™¤è­‰æ›¸ç›®éŒ„
rm -rf certificates/
# åˆªé™¤åœ˜éšŠé…ç½®ç·©å­˜ç›®éŒ„
rm -rf team-configs/
# åˆªé™¤æ—¥èªŒç›®éŒ„
rm -rf logs/
rm -rf revocation-logs/
rm -rf offboarding-logs/
# åˆªé™¤ä¸»è¦è…³æœ¬ç”¢ç”Ÿçš„ç‹€æ…‹/æ—¥èªŒæ–‡ä»¶
rm -f .vpn_config vpn_admin_*.log user_vpn_setup.log .user_vpn_config
# ï¼ˆå¯é¸ï¼‰åˆªé™¤å‡½å¼åº«å’Œè…³æœ¬æœ¬èº«
# rm -rf lib/
# rm -f *.sh readme.md vpn_connection_manual.md
```

### 13.4 ç§»é™¤æ‡‰ç”¨ç¨‹å¼ (ç”¨æˆ¶ç«¯)
- **ç§»é™¤ AWS VPN Client**:
  ```bash
  sudo rm -rf "/Applications/AWS VPN Client.app"
  # æ¸…ç†ç›¸é—œç”¨æˆ¶é…ç½® (å¦‚æœå­˜åœ¨)
  rm -rf ~/Library/Application\ Support/AWS\ VPN\ Client/
  rm -rf ~/Library/Preferences/com.amazon.awsvpnclient.plist
  ```
- **å¯é¸ï¼šç§»é™¤ Homebrew å®‰è£çš„å·¥å…·** (å¦‚æœç®¡ç†å“¡æ©Ÿå™¨ä¸å†éœ€è¦):
  ```bash
  brew uninstall awscli jq easy-rsa openssl # æ ¹æ“šå¯¦éš›å®‰è£æƒ…æ³
  ```

---

## 14. é™„éŒ„

### 14.1 å¸¸ç”¨ AWS CLI å‘½ä»¤
(é€™äº›å‘½ä»¤åœ¨è…³æœ¬å…§éƒ¨è¢«å»£æ³›ä½¿ç”¨ï¼Œç®¡ç†å“¡æ‰‹å‹•æ’éŒ¯æ™‚ä¹Ÿå¯èƒ½ç”¨åˆ°)
```bash
# VPN ç«¯é»ç®¡ç†
aws ec2 describe-client-vpn-endpoints
aws ec2 create-client-vpn-endpoint --client-ipv4-cidr <value> --server-certificate-arn <value> --authentication-options Type=certificate-authentication,MutualAuthentication={ClientRootCertificateChainArn=<value>} --connection-log-options Enabled=true,CloudwatchLogGroup=<value> --dns-servers <value> <value> --transport-protocol udp --split-tunnel --tag-specifications 'ResourceType=client-vpn-endpoint,Tags=[{Key=Name,Value=<YourVPNName>}]'
aws ec2 delete-client-vpn-endpoint --client-vpn-endpoint-id <value>
aws ec2 modify-client-vpn-endpoint --client-vpn-endpoint-id <value> --server-certificate-arn <value>

# ç¶²è·¯é—œè¯
aws ec2 associate-client-vpn-target-network --client-vpn-endpoint-id <value> --subnet-id <value>
aws ec2 disassociate-client-vpn-target-network --client-vpn-endpoint-id <value> --association-id <value>
aws ec2 describe-client-vpn-target-networks --client-vpn-endpoint-id <value>

# æˆæ¬Šç®¡ç†
aws ec2 authorize-client-vpn-ingress --client-vpn-endpoint-id <value> --target-network-cidr <value> --authorize-all-groups | --access-group-id <value>
aws ec2 revoke-client-vpn-ingress --client-vpn-endpoint-id <value> --target-network-cidr <value> --revoke-all-groups | --access-group-id <value>
aws ec2 describe-client-vpn-authorization-rules --client-vpn-endpoint-id <value>

# è·¯ç”±ç®¡ç†
aws ec2 create-client-vpn-route --client-vpn-endpoint-id <value> --destination-cidr-block <value> --target-subnet-id <value>
aws ec2 delete-client-vpn-route --client-vpn-endpoint-id <value> --destination-cidr-block <value> --target-subnet-id <value>
aws ec2 describe-client-vpn-routes --client-vpn-endpoint-id <value>

# é€£æ¥ç®¡ç†
aws ec2 describe-client-vpn-connections --client-vpn-endpoint-id <value>
aws ec2 terminate-client-vpn-connections --client-vpn-endpoint-id <value> --connection-id <value>

# è­‰æ›¸ç®¡ç† (ACM)
aws acm list-certificates --certificate-statuses ISSUED
aws acm import-certificate --certificate fileb://path/to/cert.pem --private-key fileb://path/to/key.pem --certificate-chain fileb://path/to/chain.pem --tags Key=Name,Value=YourCertName
aws acm delete-certificate --certificate-arn <value>
aws acm describe-certificate --certificate-arn <value>
```

### 14.2 é…ç½®æ–‡ä»¶ç¯„ä¾‹ (`.vpn_config`)
æ­¤æ–‡ä»¶ç”± `vpn_env.sh` ç®¡ç†ï¼Œå­˜å„²ç•¶å‰æ¿€æ´»çš„ç’°å¢ƒã€‚
```bash
# .vpn_config ç¤ºä¾‹
CURRENT_ENV_NAME="staging"
CURRENT_ENV_FILE="/path/to/your/project/configs/staging/staging.env"
```

**`configs/[environment]/[environment].env` ç¯„ä¾‹çµæ§‹:**
```bash
# configs/staging/staging.env ç¤ºä¾‹
# AWS Configuration
AWS_REGION="ap-northeast-1"
AWS_PROFILE="default" # Optional: specify AWS CLI profile

# VPN Endpoint Configuration
VPN_NAME_PREFIX="StagingVPN"
VPN_CLIENT_CIDR="172.16.0.0/22" # Client IPv4 CIDR
SERVER_CERT_ARN="" # To be filled by script
CLIENT_CERT_ARN="" # To be filled by script
DNS_SERVERS="8.8.8.8 8.8.4.4" # Or internal DNS servers
TRANSPORT_PROTOCOL="udp" # udp or tcp
SPLIT_TUNNEL="true" # true or false
CONNECTION_LOG_GROUP_PREFIX="/aws/clientvpn" # CloudWatch Log Group name prefix

# Target Network (Primary VPC and Subnet)
TARGET_VPC_ID="vpc-xxxxxxxxxxxxxxxxx" # Primary VPC for this VPN
TARGET_SUBNET_IDS="subnet-xxxxxxxxxxxxxxxxx,subnet-yyyyyyyyyyyyyyyyy" # Comma-separated list of subnet IDs for association

# Authorization Rules (CIDRs to allow access to)
AUTHORIZATION_TARGET_CIDRS="10.10.0.0/16,0.0.0.0/0" # Example: VPC CIDR and all internet

# Easy-RSA Configuration (used by cert_management.sh)
EASYRSA_DIR="/usr/local/opt/easy-rsa/share/easy-rsa" # Path to easy-rsa scripts, adjust if different
CERT_ROOT_DIR="./certificates/staging" # Output for generated certs, relative to project root
PKI_DIR="${CERT_ROOT_DIR}/pki"
CA_CERT_FILENAME="ca.crt"
SERVER_CERT_FILENAME_PREFIX="server"
CLIENT_CERT_FILENAME_PREFIX="client" # For generic client certs, user certs are separate
CERT_VALIDITY_DAYS_CA=3650 # 10 years for CA
CERT_VALIDITY_DAYS_SERVER=365 # 1 year for server
CERT_VALIDITY_DAYS_CLIENT=180 # 6 months for client

# Tags for AWS resources
TAG_ENV="Staging"
TAG_PROJECT="ClientVPNManagement"

# VPN Endpoint ID (filled after creation)
VPN_ENDPOINT_ID=""
```

### 14.3 IAM æ¬Šé™æ”¿ç­–ç¯„ä¾‹

#### ç®¡ç†å“¡æ¬Šé™ (`aws_vpn_admin.sh`, `revoke_member_access.sh`, `employee_offboarding.sh`)
æ­¤ç‚ºè¼ƒå¯¬é¬†ç¯„ä¾‹ï¼Œè«‹æ ¹æ“šæœ€å°æ¬Šé™åŸå‰‡èª¿æ•´ã€‚
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "ec2:CreateClientVpnEndpoint",
                "ec2:ModifyClientVpnEndpoint",
                "ec2:DeleteClientVpnEndpoint",
                "ec2:DescribeClientVpnEndpoints",
                "ec2:AssociateClientVpnTargetNetwork",
                "ec2:DisassociateClientVpnTargetNetwork",
                "ec2:DescribeClientVpnTargetNetworks",
                "ec2:AuthorizeClientVpnIngress",
                "ec2:RevokeClientVpnIngress",
                "ec2:DescribeClientVpnAuthorizationRules",
                "ec2:CreateClientVpnRoute",
                "ec2:DeleteClientVpnRoute",
                "ec2:DescribeClientVpnRoutes",
                "ec2:DescribeClientVpnConnections",
                "ec2:TerminateClientVpnConnections",
                "ec2:DescribeVpcs",
                "ec2:DescribeSubnets",
                "ec2:DescribeSecurityGroups",
                "ec2:CreateTags",
                "ec2:DeleteTags",
                "acm:ImportCertificate",
                "acm:DeleteCertificate",
                "acm:DescribeCertificate",
                "acm:ListCertificates",
                "acm:AddTagsToCertificate",
                "logs:CreateLogGroup",
                "logs:DeleteLogGroup",
                "logs:DescribeLogGroups",
                "logs:CreateLogStream",
                "logs:PutLogEvents",
                "iam:GetUser", // For employee_offboarding.sh
                "iam:ListUserPolicies", // For employee_offboarding.sh
                "iam:ListAttachedUserPolicies", // For employee_offboarding.sh
                "iam:DeleteUser", // For employee_offboarding.sh (use with extreme caution)
                "iam:DetachUserPolicy", // For employee_offboarding.sh
                "iam:DeleteLoginProfile", // For employee_offboarding.sh
                "sts:GetCallerIdentity"
            ],
            "Resource": "*" // For production, scope down resources where possible
        }
    ]
}
```

#### åœ˜éšŠæˆå“¡è¨­ç½®æ¬Šé™ (`team_member_setup.sh` ç”¨æˆ¶ç«¯åŸ·è¡Œæ™‚)
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "ec2:DescribeClientVpnEndpoints", // To get endpoint details for config
                "acm:ImportCertificate",          // To upload their own client certificate
                "acm:AddTagsToCertificate"        // To tag their certificate
            ],
            "Resource": "*" // Scope down if possible, e.g., specific VPN endpoint ARN for describe
                           // For acm:ImportCertificate, it's harder to scope down without pre-creating placeholders
        },
        {
            "Effect": "Allow",
            "Action": "sts:GetCallerIdentity",
            "Resource": "*"
        }
    ]
}
```

### 14.4 ç·Šæ€¥è¯çµ¡ç¯„æœ¬
(æ­¤ç‚ºç®¡ç†å“¡å…§éƒ¨ä½¿ç”¨ç¯„æœ¬ï¼Œæˆ–æä¾›çµ¦é—œéµç”¨æˆ¶)
```text
=== VPN ç·Šæ€¥äº‹ä»¶è™•ç†æŒ‡å¼• ===

äº‹ä»¶é¡å‹ï¼š (ä¾‹å¦‚ï¼šVPN é€£æ¥å®Œå…¨ä¸­æ–· / å®‰å…¨æ¼æ´ç–‘ä¼¼ / é—œéµç”¨æˆ¶ç„¡æ³•é€£æ¥)
å ±å‘Šæ™‚é–“ï¼š YYYY-MM-DD HH:MM
å ±å‘Šäººï¼š

å—å½±éŸ¿ç’°å¢ƒï¼š [ ] Staging [ ] Production [ ] Both

ç¾è±¡æè¿°ï¼š
...

å·²å˜—è©¦çš„åˆæ­¥æ’é™¤æ­¥é©Ÿï¼š
1. ./vpn_env.sh status
2. ./vpn_env.sh health [environment]
3. ...

AWS è³‡æºä¿¡æ¯ (è‹¥å·²çŸ¥)ï¼š
Staging VPN ç«¯é» ID: cvpn-xxxxxxxx (å¾ configs/staging/staging.env ç²å–)
Production VPN ç«¯é» ID: cvpn-yyyyyyyy (å¾ configs/production/production.env ç²å–)
ç›¸é—œ CloudWatch Log Group: /aws/clientvpn/[VPN_Name]

ç·Šæ€¥è¯çµ¡äººï¼š
1. ä¸»è¦ VPN ç®¡ç†å“¡: [å§“å], [é›»è©±], [Email]
2. å‚™ç”¨ VPN ç®¡ç†å“¡: [å§“å], [é›»è©±], [Email]
3. IT å®‰å…¨éƒ¨é–€: [è¯ç¹«æ–¹å¼]

è™•ç†è¨˜éŒ„ï¼š
(æ™‚é–“ - æ“ä½œ - çµæœ)
...
```

---

## 15. å¸¸è¦‹å•é¡Œ FAQ

(æ­¤éƒ¨åˆ†å…§å®¹èˆ‡ `vpn_connection_manual.md` v2.0 ç‰ˆæœ¬ä¸€è‡´ï¼Œå¯æ ¹æ“šæ–°åŠŸèƒ½é…Œæƒ…å¢è£œ)
- Q1ï¼šä»€éº¼æ™‚å€™æ‡‰è©²ä½¿ç”¨ Staging ç’°å¢ƒï¼Ÿä»€éº¼æ™‚å€™ä½¿ç”¨ Production ç’°å¢ƒï¼Ÿ
- Q2ï¼šæˆ‘å¯ä»¥åŒæ™‚é€£æ¥å…©å€‹ç’°å¢ƒå—ï¼Ÿ (A: å¼·çƒˆä¸å»ºè­°)
- Q3ï¼šå¦‚ä½•ç¢ºèªæˆ‘ç•¶å‰é€£æ¥çš„æ˜¯å“ªå€‹ç’°å¢ƒï¼Ÿ (A: `./vpn_env.sh status`, Client Profile Name)
- Q4ï¼šæˆ‘åœ¨åˆ‡æ›ç’°å¢ƒæ™‚è¢«è¦æ±‚è¼¸å…¥ç¢ºèªç¢¼ï¼Œé€™æ˜¯ä»€éº¼ï¼Ÿ (A: Production ç’°å¢ƒä¿è­·æ©Ÿåˆ¶)
- ...

---

## 16. ç·Šæ€¥è¯çµ¡è³‡è¨Š

(æ­¤éƒ¨åˆ†å…§å®¹èˆ‡ `vpn_connection_manual.md` v2.0 ç‰ˆæœ¬ä¸€è‡´ï¼Œç¢ºä¿è³‡è¨Šæœ€æ–°)

### ğŸš¨ ç·Šæ€¥æƒ…æ³è¯çµ¡æ–¹å¼
#### ğŸ”´ ç”Ÿç”¢ç’°å¢ƒç·Šæ€¥å•é¡Œ
- **è¯çµ¡äºº**: IT ç³»çµ±ç®¡ç†å“¡
- **é›»è©±**: +886-2-XXXX-XXXX (24å°æ™‚)
- **Email**: <it-emergency@company.com>
- **Slack**: #emergency-it

#### ğŸŸ¡ ä¸€èˆ¬ VPN æŠ€è¡“æ”¯æ´
- **è¯çµ¡äºº**: IT æŠ€è¡“æ”¯æ´åœ˜éšŠ
- **é›»è©±**: +886-2-XXXX-XXXX (ä¸Šç­æ™‚é–“)
- **Email**: <it-support@company.com>
- **Slack**: #it-support

---

**ç¥æ‚¨ä½¿ç”¨é †åˆ©ï¼** ğŸ‰
