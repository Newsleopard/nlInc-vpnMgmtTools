# AWS Client VPN 雙環境支援重構計畫

**專案：** nlInc-vpnMgmtTools  
**目標：** 支援 Staging 和 Production 雙環境切換使用  
**重構範圍：** 環境管理架構設計與實施方案  
**版本：** v1.0  
**日期：** 2025年5月24日

---

## 📋 目錄

1. [重構背景與目標](#重構背景與目標)
2. [現況分析](#現況分析)
3. [架構設計方案](#架構設計方案)
4. [環境配置管理](#環境配置管理)
5. [核心功能重構策略](#核心功能重構策略)
6. [使用者體驗設計](#使用者體驗設計)
7. [安全隔離策略](#安全隔離策略)
8. [實施階段規劃](#實施階段規劃)
9. [風險評估與應對](#風險評估與應對)

---

## 🎯 重構背景與目標

### 業務需求
- **開發測試環境 (Staging)**：供開發團隊進行功能測試、整合測試使用
- **生產營運環境 (Production)**：供正式營運、業務操作使用
- **環境切換需求**：管理員和用戶需要能夠按需在兩環境間切換

### 重構目標

#### 1. 環境完全隔離
- 兩個環境的所有資源（端點、證書、配置、日誌）完全分離
- 防止環境間的資源混淆和意外訪問
- 獨立的證書管理系統

#### 2. 靈活環境切換
- 提供直觀的環境選擇機制
- 一鍵環境切換功能
- 環境狀態實時顯示

#### 3. 統一管理介面
- 單一工具管理雙環境
- 一致的操作流程和體驗
- 環境間配置比較功能

#### 4. 安全性增強
- 環境識別和確認機制
- 操作審計和日誌記錄
- 誤操作防護措施

---

## 🔍 現況分析

### 當前架構限制

#### 1. 單一環境設計
- 配置檔案 `.vpn_config` 和 `.user_vpn_config` 僅支援單一端點
- 所有腳本預設操作單一 VPN 環境
- 證書管理缺乏環境區分

#### 2. 配置管理問題
- 環境參數散布在各個腳本中
- 缺乏集中化的環境配置管理
- 環境切換需要手動修改多個檔案

#### 3. 使用者體驗問題
- 無直觀的環境識別方式
- 環境切換流程複雜
- 缺乏環境狀態指示

#### 4. 安全風險
- 容易在錯誤環境執行操作
- 缺乏環境操作確認機制
- 無法追蹤環境切換歷史

---

## 🏗️ 架構設計方案

### 整體架構概念

```
多環境 VPN 管理系統
├── 環境管理層
│   ├── 環境發現與註冊
│   ├── 環境狀態管理
│   └── 環境切換控制
├── 配置管理層
│   ├── 全域配置
│   ├── 環境特定配置
│   └── 使用者配置
├── 資源隔離層
│   ├── 獨立證書系統
│   ├── 分離的端點管理
│   └── 環境專屬日誌
└── 使用者介面層
    ├── 環境選擇器
    ├── 狀態指示器
    └── 統一操作介面
```

### 核心設計原則

#### 1. 環境優先原則
- 所有操作都從環境選擇開始
- 環境身份在整個操作過程中保持明確
- 配置和資源按環境組織

#### 2. 配置分層原則
- 全域配置提供共同預設值
- 環境配置覆蓋環境特定設定
- 使用者配置覆蓋個人偏好

#### 3. 資源隔離原則
- 每個環境擁有獨立的資源目錄
- 證書、配置、日誌完全分離
- 環境間無共享資源

#### 4. 安全第一原則
- 所有環境操作都需要明確確認
- 提供操作審計和歷史記錄
- 實施防誤操作保護機制

---

## ⚙️ 環境配置管理

### 簡化目錄結構

```
nlInc-vpnMgmtTools/
├── 📁 核心工具
│   ├── aws_vpn_admin.sh
│   ├── team_member_setup.sh
│   ├── revoke_member_access.sh
│   └── employee_offboarding.sh
├── 📁 函式庫
│   ├── lib/core_functions.sh
│   ├── lib/aws_setup.sh
│   ├── lib/cert_management.sh
│   ├── lib/endpoint_creation.sh
│   ├── lib/endpoint_management.sh
│   └── 🆕 lib/env_manager.sh    # 簡化的環境管理器
├── 🆕 📁 環境配置
│   ├── staging.env              # Staging 環境配置
│   ├── production.env           # Production 環境配置
│   └── .current_env             # 當前環境指標
└── 🆕 📁 環境資源
    ├── staging/
    │   ├── certificates/
    │   ├── configs/
    │   └── logs/
    └── production/
        ├── certificates/
        ├── configs/
        └── logs/
```

### 簡化配置檔案架構

#### 環境配置檔案
**Staging 環境 (staging.env)**
```bash
# 環境識別
ENV_NAME=staging
ENV_DISPLAY_NAME="Staging Environment"
ENV_COLOR=yellow
ENV_ICON=🟡

# AWS 設定
AWS_REGION=ap-northeast-1
AWS_PROFILE=staging-vpn-admin

# VPN 配置
VPN_CIDR=172.16.0.0/22
VPN_NAME=Staging-VPN
ENDPOINT_ID=cvpn-endpoint-staging123

# 網路設定
PRIMARY_VPC_ID=vpc-staging123
PRIMARY_VPC_CIDR=10.1.0.0/16
PRIMARY_SUBNET_ID=subnet-staging123
```

**Production 環境 (production.env)**
```bash
# 環境識別
ENV_NAME=production
ENV_DISPLAY_NAME="Production Environment"
ENV_COLOR=red
ENV_ICON=🔴

# AWS 設定
AWS_REGION=ap-northeast-1
AWS_PROFILE=production-vpn-admin

# VPN 配置
VPN_CIDR=172.20.0.0/22
VPN_NAME=Production-VPN
ENDPOINT_ID=cvpn-endpoint-prod456

# 網路設定
PRIMARY_VPC_ID=vpc-prod456
PRIMARY_VPC_CIDR=10.0.0.0/16
PRIMARY_SUBNET_ID=subnet-prod456

# Production 安全強化
REQUIRE_MFA_FOR_ADMIN=true
ENABLE_AUDIT_LOGGING=true
```

#### 當前環境指標 (.current_env)
```bash
CURRENT_ENVIRONMENT=staging
LAST_SWITCHED_TIME=2025-05-24T10:30:00Z
SWITCHED_BY=admin
```

---

## 🔧 簡化核心功能重構策略

### 簡化環境管理器 (lib/env_manager.sh)

#### 核心功能
1. **環境切換**：提供簡單的環境切換功能
2. **配置載入**：根據環境載入對應配置
3. **狀態追蹤**：記錄當前環境狀態

#### 主要函式
```bash
# 基本環境操作
env_current()                 # 顯示當前環境
env_switch(env_name)          # 切換環境
env_load_config(env_name)     # 載入環境配置
```

### 簡化證書管理

#### 環境隔離策略
- 每個環境有獨立的證書目錄
- 證書檔案按環境分別存放
- 簡單的環境標識機制

### 簡化端點管理

#### 環境感知操作
- 根據當前環境選擇對應端點
- 簡化的配置管理
- 基本的環境驗證

---

## 🎨 使用者體驗設計

### 環境選擇器設計

#### 互動式環境選擇介面
```bash
=== AWS Client VPN 多環境管理控制台 ===

當前環境: 🟡 Staging (活躍)

可用環境:
  1. 🟡 Staging    - 開發測試環境    [3個活躍連線]
  2. 🔴 Production - 生產營運環境    [8個活躍連線]

快速操作:
  [E] 切換環境    [S] 環境狀態    [H] 健康檢查

請選擇環境或操作 [1-2/E/S/H]:
```

#### 環境狀態指示器
- **顏色編碼**：🟡 Staging (黃色)、🔴 Production (紅色)
- **狀態圖示**：🟢 健康、🟡 警告、🔴 錯誤、⚪ 未知
- **即時資訊**：連線數、資源使用、最後檢查時間

### 改進的使用者流程

#### 管理員工作流程
1. **環境選擇確認** → 2. **環境狀態驗證** → 3. **操作執行** → 4. **結果確認**

#### 團隊成員設置流程
1. **環境選擇** → 2. **配置下載** → 3. **證書設置** → 4. **連線測試**

#### 環境切換流程
1. **當前狀態保存** → 2. **切換確認** → 3. **環境載入** → 4. **狀態驗證**

### 安全確認機制

#### 操作確認提示
```bash
⚠️  您即將在 Production 環境執行以下操作：
   • 建立新的 VPN 端點
   • 影響範圍：生產網路環境
   
確認執行此操作？ [yes/NO]: 
```

#### 環境切換確認
```bash
🔄 環境切換確認

從：🟡 Staging Environment
到：🔴 Production Environment

此操作將：
• 切換所有後續操作到 Production 環境
• 載入 Production 環境配置
• 記錄環境切換歷史

確認切換？ [yes/NO]:
```

---

## 🔒 安全隔離策略

### 環境安全邊界

#### 1. 配置隔離
- **獨立配置目錄**：每個環境擁有完全分離的配置目錄
- **存取權限控制**：檔案權限防止跨環境配置洩露
- **配置加密**：敏感配置資料加密儲存

#### 2. 證書隔離
- **獨立 CA 系統**：每個環境有獨立的憑證頒發機構
- **證書環境標記**：證書包含環境特定標籤和限制
- **交叉驗證防護**：防止證書在錯誤環境中使用

#### 3. 網路隔離
- **VPC 分離**：不同環境使用不同的 VPC
- **CIDR 區段**：使用不重疊的 IP 位址段
- **安全群組**：環境特定的安全群組規則

### 安全監控和審計

#### 1. 操作審計
- **環境切換日誌**：記錄所有環境切換操作
- **操作歷史**：追蹤在各環境中的操作記錄
- **異常行為監控**：檢測異常的環境使用模式

#### 2. 合規性檢查
- **配置合規**：定期檢查配置是否符合安全政策
- **證書合規**：驗證證書使用是否符合規範
- **存取合規**：審計使用者存取權限是否適當

---

## 📅 簡化實施規劃

### 階段一：核心環境架構 (1-2 週)

#### 目標
- 建立雙環境基礎架構
- 實現環境切換核心功能

#### 主要任務
1. **建立簡化目錄結構**
   ```
   configs/
   ├── staging/          # Staging 環境配置
   └── production/       # Production 環境配置
   
   certs/
   ├── staging/          # Staging 環境證書
   └── production/       # Production 環境證書
   ```

2. **開發基本環境管理器**
   - 實現 `env_current()` - 顯示當前環境
   - 實現 `env_switch()` - 切換環境  
   - 實現 `env_load_config()` - 載入環境配置

### 階段二：核心功能實作 (2-3 週)

#### 目標
- 實作環境感知的核心腳本
- 建立安全的環境隔離

#### 主要任務
1. **更新核心腳本**
   - 修改 `aws_vpn_admin.sh` 加入環境選擇
   - 更新 `team_member_setup.sh` 支援環境配置
   - 調整其他工具腳本的環境支援

2. **實現環境隔離**
   - 獨立的證書管理
   - 環境特定的 AWS 資源
   - 配置檔案隔離

### 階段三：使用者介面完善 (1-2 週)

#### 目標
- 建立友善的使用者體驗
- 實現安全確認機制

#### 主要任務
1. **環境選擇器**
   - 互動式環境選擇介面
   - 環境狀態指示器
   - 操作確認提示

2. **基本測試和驗證**
   - 功能測試
   - 環境隔離驗證
   - 使用者操作測試

---

## ⚠️ 簡化風險評估

### 主要技術風險

#### 風險1：環境切換故障
- **風險描述**：環境切換過程中可能發生配置載入錯誤
- **影響等級**：中等
- **應對策略**：實現配置驗證機制、提供錯誤訊息提示

#### 風險2：環境誤操作
- **風險描述**：使用者可能在錯誤的環境執行操作
- **影響等級**：高
- **應對策略**：實現環境確認機制、提供清晰的環境指示

### 主要安全風險

#### 風險1：環境間資源混淆
- **風險描述**：配置或證書可能在錯誤環境中使用
- **影響等級**：高
- **應對策略**：實施檔案權限控制、建立環境標識驗證

#### 風險2：證書管理安全
- **風險描述**：多環境證書儲存和使用的安全風險
- **影響等級**：中等
- **應對策略**：實現證書環境隔離、加強存取控制

---

## 📊 簡化成功指標

### 核心功能指標
- ✅ 環境切換時間 < 10 秒
- ✅ 配置載入成功率 > 95%
- ✅ 環境狀態檢查準確度 > 99%

### 使用者體驗指標
- ✅ 環境選擇步驟 ≤ 2 步
- ✅ 操作流程直觀性評分 > 4/5
- ✅ 環境誤操作率 < 1%

### 安全指標
- ✅ 環境隔離驗證通過率 = 100%
- ✅ 配置檔案權限合規率 = 100%
- ✅ 證書環境隔離有效性 = 100%

---

## 🎯 簡化結論

本重構計畫將建立支援 Staging 和 Production 雙環境的 VPN 管理系統。由於專案尚在開發階段，我們採用簡化設計：

### 核心設計原則
1. **簡潔的環境架構**：採用最少必要的目錄結構和配置層級
2. **直觀的環境切換**：提供簡單易用的環境選擇和切換機制
3. **安全的環境隔離**：確保 Staging 和 Production 環境完全分離
4. **友善的使用者體驗**：維持一致且直觀的操作流程

### 預期效益
- **環境隔離**：開發測試和生產營運的安全分離
- **操作簡化**：統一的管理介面和操作流程
- **擴展彈性**：為未來功能擴展建立基礎架構
- **維護便利**：簡化的配置管理降低維護複雜度

此簡化方案在滿足雙環境需求的同時，避免了過度設計的複雜性，為團隊提供實用且可維護的解決方案。
